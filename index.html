<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L'Académie - Aprende y Repasa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Montserrat', 'sans-serif'], serif: ['Merriweather', 'serif'] },
                    colors: { frBlue: '#002654', frRed: '#ED2939', frCream: '#F5F5DC', gold: '#D4AF37' },
                    boxShadow: { 'card': '0 10px 15px -3px rgba(0, 0, 0, 0.1)', 'btn': '0px 4px 0px 0px rgba(0,0,0,0.3)' }
                }
            }
        }
    </script>

    <style>
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #002654; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        
        /* Lesson Content Styles */
        .lesson-content h2 { color: #002654; font-weight: 700; margin-top: 1.5em; margin-bottom: 0.5em; font-size: 1.25em; }
        .lesson-content p { margin-bottom: 1em; line-height: 1.8; color: #374151; }
        .lesson-content ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .lesson-content strong { color: #ED2939; font-weight: 700; }
        .lesson-content .conjugation-table { width: 100%; border-collapse: collapse; margin: 1em 0; font-size: 0.9em; }
        .lesson-content .conjugation-table td, .lesson-content .conjugation-table th { border: 1px solid #e5e7eb; padding: 8px; }
        .lesson-content .conjugation-table th { background-color: #f3f4f6; color: #002654; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 h-screen flex flex-col overflow-hidden">

    <!-- NAVBAR -->
    <nav class="bg-frBlue text-white shadow-lg z-50 relative">
        <div class="max-w-5xl mx-auto px-4 h-16 flex justify-between items-center">
            <div class="flex items-center gap-3 cursor-pointer hover:opacity-80 transition" onclick="app.renderMap()">
                <i class="fa-solid fa-landmark text-gold text-2xl"></i>
                <h1 class="font-bold text-lg tracking-wider uppercase">L'Académie</h1>
            </div>
            <button onclick="app.renderFlashcards()" class="bg-white/10 hover:bg-white/20 text-white px-3 py-1 rounded-lg text-sm font-bold transition flex items-center gap-2">
                <i class="fa-solid fa-layer-group text-gold"></i> <span class="hidden sm:inline">Révisions</span>
            </button>
        </div>
        <div class="h-1 w-full flex"><div class="w-1/3 bg-blue-600"></div><div class="w-1/3 bg-white"></div><div class="w-1/3 bg-red-600"></div></div>
    </nav>

    <!-- MAIN CONTENT -->
    <main id="app-container" class="flex-1 overflow-y-auto relative bg-[#fdfbf7]">
        <div class="h-full flex flex-col items-center justify-center">
            <div class="loader"></div>
            <p class="text-gray-500 mt-2">Detecting lessons...</p>
        </div>
    </main>

    <script>
        const app = {
            container: document.getElementById('app-container'),
            modules: [],
            progress: JSON.parse(localStorage.getItem('acad_progress') || '[]'),
            userVocab: JSON.parse(localStorage.getItem('acad_user_vocab') || '[]'),
            currentLessonData: null,
            // Define the remote base URL
            baseUrl: 'https://clement-torti.github.io/french-quest/',

            async init() {
                await this.discoverModules();
                // Re-draw path on window resize to keep lines connected
                window.addEventListener('resize', () => this.drawMapPath());
            },

            // --- AUTO DISCOVERY ENGINE (REMOTE) ---
            async discoverModules() {
                let id = 1;
                let keepSearching = true;

                while (keepSearching) {
                    // Construct the remote URL
                    const url = `${this.baseUrl}lesson${id}.html`;
                    
                    try {
                        const response = await fetch(url);
                        
                        if (response.ok) {
                            const text = await response.text();
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(text, 'text/html');
                            const jsonScript = doc.getElementById('lesson-data');
                            
                            if (jsonScript) {
                                const data = JSON.parse(jsonScript.textContent);
                                this.modules.push({
                                    id: id,
                                    filename: url, // Store the full remote URL
                                    title: data.title,
                                    icon: data.icon || 'fa-book',
                                    desc: data.desc
                                });
                            }
                            id++;
                        } else {
                            // 404 or other error stops the search
                            keepSearching = false;
                        }
                    } catch (e) {
                        console.warn("Scanner stopped:", e);
                        keepSearching = false;
                    }
                }
                
                if (this.modules.length === 0) {
                    this.container.innerHTML = `<div class="p-10 text-center text-red-500 font-bold">No lessons found at remote URL.<br>${this.baseUrl}</div>`;
                } else {
                    this.renderMap();
                }
            },

            // --- MAP ---
            renderMap() {
                let htmlNodes = '';
                this.modules.forEach((mod, idx) => {
                    const isCompleted = this.progress.includes(mod.id);
                    const isNext = !isCompleted && (idx === 0 || this.progress.includes(this.modules[idx-1].id));
                    const isLocked = !isCompleted && !isNext;
                    
                    // Zig-zag offset
                    const offset = (idx % 2 === 0) ? '-translate-x-12' : 'translate-x-12';
                    
                    let btnClass = isLocked ? "bg-gray-200 text-gray-400 border-gray-300 cursor-not-allowed" : (isCompleted ? "bg-gold text-white border-yellow-500 shadow-lg" : "bg-frBlue text-white border-blue-800 shadow-xl animate-pulse");
                    let icon = isLocked ? "fa-lock" : (isCompleted ? "fa-check" : mod.icon);

                    htmlNodes += `
                        <div class="flex flex-col items-center mb-16 relative z-10 w-full pointer-events-none">
                            <div class="pointer-events-auto flex flex-col items-center transform transition-transform duration-300 ${offset}" id="node-${idx}">
                                ${!isLocked ? `<div class="mb-2 text-xs font-bold text-frBlue uppercase tracking-wider bg-white/90 px-3 py-1 rounded shadow-sm backdrop-blur-sm border border-gray-100">${mod.title}</div>` : ''}
                                
                                <button onclick="${isLocked ? '' : `app.loadLesson(${mod.id}, '${mod.filename}')`}" 
                                    class="w-20 h-20 rounded-full flex flex-col items-center justify-center text-3xl transition-all hover:scale-110 hover:-translate-y-1 border-b-4 ${btnClass}">
                                    <i class="fa-solid ${icon}"></i>
                                </button>
                                
                                <!-- Lesson Number Badge -->
                                <div class="mt-2 bg-white text-gray-500 text-[10px] font-black px-2 py-1 rounded-full border border-gray-200 shadow-sm uppercase tracking-widest">
                                    Leçon ${mod.id}
                                </div>
                            </div>
                        </div>
                    `;
                });

                this.container.innerHTML = `
                    <div class="min-h-full py-12 relative overflow-x-hidden animate-fade-in">
                        <!-- SVG Container for the curvy line -->
                        <svg id="map-svg" class="absolute top-0 left-0 w-full h-full z-0 pointer-events-none overflow-visible">
                            <path id="map-path" d="" stroke="#cbd5e1" stroke-width="4" fill="none" stroke-dasharray="8 8" stroke-linecap="round" />
                        </svg>

                        <i class="fa-solid fa-tower-eiffel absolute bottom-0 left-4 text-[150px] text-gray-200 opacity-40 z-0"></i>
                        
                        <div class="max-w-md mx-auto relative z-10 flex flex-col items-center w-full">
                            ${htmlNodes}
                        </div>
                    </div>
                `;

                // Calculate and draw the line after the HTML renders
                setTimeout(() => this.drawMapPath(), 50);
            },

            // New helper to calculate positions and draw the curve
            drawMapPath() {
                const svg = document.getElementById('map-svg');
                const path = document.getElementById('map-path');
                if (!svg || !path || this.modules.length < 2) return;

                // Get container offset to calculate relative coordinates
                const containerRect = this.container.getBoundingClientRect();
                let d = '';

                for (let i = 0; i < this.modules.length - 1; i++) {
                    const currNode = document.getElementById(`node-${i}`);
                    const nextNode = document.getElementById(`node-${i+1}`);

                    if (currNode && nextNode) {
                        // Get center positions of the buttons
                        const r1 = currNode.getBoundingClientRect();
                        const r2 = nextNode.getBoundingClientRect();

                        // Calculate relative to the container scroll area
                        const startX = r1.left + r1.width / 2;
                        const startY = r1.top + r1.height / 2 - containerRect.top + this.container.scrollTop;
                        
                        const endX = r2.left + r2.width / 2;
                        const endY = r2.top + r2.height / 2 - containerRect.top + this.container.scrollTop;

                        // Create a Bezier curve (C)
                        const cp1X = startX; 
                        const cp1Y = startY + (endY - startY) * 0.5; 
                        const cp2X = endX; 
                        const cp2Y = startY + (endY - startY) * 0.5;

                        if (i === 0) d += `M ${startX} ${startY} `;
                        d += `C ${cp1X} ${cp1Y}, ${cp2X} ${cp2Y}, ${endX} ${endY} `;
                    }
                }
                path.setAttribute('d', d);
            },

            // --- LESSON LOADER ---
            async loadLesson(id, url) {
                this.container.innerHTML = `<div class="h-full flex items-center justify-center"><div class="loader"></div></div>`;

                try {
                    const response = await fetch(url);
                    const htmlText = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(htmlText, 'text/html');

                    const parsedData = JSON.parse(doc.getElementById('lesson-data').textContent);
                    const contentHtml = doc.getElementById('lesson-content').innerHTML;

                    this.currentLessonData = { ...parsedData, id: id, content: contentHtml };
                    this.renderLessonUI();
                } catch (error) {
                    console.error(error);
                    this.container.innerHTML = `<p class="text-center p-10 text-red-500">Error loading lesson from remote server.</p>`;
                }
            },

            renderLessonUI() {
                const data = this.currentLessonData;
                this.currentLessonState = new Array(data.exercises.length).fill(false);

                const exHtml = data.exercises.map((ex, i) => `
                    <div class="bg-white p-6 rounded-xl shadow-card border-l-4 border-gray-200 mb-4 transition-colors duration-300" id="card-${i}">
                        <p class="font-bold text-gray-700 mb-2">${ex.q}</p>
                        <div class="flex gap-2">
                            <input type="text" id="input-${i}" class="flex-1 border rounded p-2 outline-none focus:border-frBlue" placeholder="...">
                            <button onclick="app.checkAnswer(${i}, '${ex.a}')" class="bg-frBlue text-white px-4 py-2 rounded font-bold uppercase text-xs shadow-btn active:translate-y-1 active:shadow-none">OK</button>
                        </div>
                        <div id="feedback-${i}" class="hidden mt-2 text-sm font-bold"></div>
                        ${ex.hint ? `<p class="text-xs text-gray-400 mt-1">Pista: ${ex.hint}</p>` : ''}
                    </div>
                `).join('');

                this.container.innerHTML = `
                    <div class="bg-frCream min-h-full flex flex-col animate-fade-in">
                        <div class="bg-frBlue text-white p-8 relative shadow-lg">
                            <button onclick="app.renderMap()" class="absolute top-4 left-4 opacity-70 hover:opacity-100"><i class="fa-solid fa-arrow-left"></i></button>
                            <h1 class="text-3xl font-serif font-bold mt-4">${data.title}</h1>
                            <p class="text-blue-100 text-sm mt-2">${data.desc}</p>
                        </div>
                        <div class="max-w-2xl mx-auto w-full p-6 pb-20">
                            <article class="bg-white p-8 rounded-lg shadow-sm font-serif text-gray-700 lesson-content mb-8">
                                ${data.content}
                            </article>
                            <h3 class="font-bold text-frBlue mb-4 uppercase tracking-widest text-sm">Pratique</h3>
                            ${exHtml}
                            <div id="completion-msg" class="hidden mt-8 text-center bg-white p-6 rounded-xl shadow-lg border-t-4 border-gold">
                                <div class="inline-block bg-green-100 text-green-800 px-6 py-2 rounded-full font-bold mb-4 border border-green-200">
                                    <i class="fa-solid fa-check"></i> Lección Completada
                                </div>
                                <p class="text-sm text-gray-500 mb-4">¡Vocabulario guardado!</p>
                                <button onclick="app.renderFlashcards()" class="bg-gold text-white font-bold px-8 py-3 rounded-lg shadow-lg hover:bg-yellow-600 transition animate-bounce">
                                    Ir a Repasar <i class="fa-solid fa-layer-group ml-2"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            },

            checkAnswer(idx, correct) {
                const input = document.getElementById(`input-${idx}`);
                const feedback = document.getElementById(`feedback-${idx}`);
                const card = document.getElementById(`card-${idx}`);
                
                if (input.value.trim().toLowerCase() === correct.toLowerCase()) {
                    card.classList.remove('border-gray-200'); card.classList.add('border-green-500', 'bg-green-50');
                    feedback.innerHTML = `<span class="text-green-600">Correct!</span>`; feedback.classList.remove('hidden');
                    input.disabled = true;
                    this.currentLessonState[idx] = true;
                    this.checkCompletion();
                } else {
                    input.classList.add('bg-red-50');
                    feedback.innerHTML = `<span class="text-red-500">Inténtalo de nuevo</span>`; feedback.classList.remove('hidden');
                    setTimeout(() => input.classList.remove('bg-red-50'), 500);
                }
            },

            checkCompletion() {
                if (this.currentLessonState.every(v => v === true)) {
                    const lessonId = this.currentLessonData.id;
                    if (!this.progress.includes(lessonId)) {
                        this.progress.push(lessonId);
                        localStorage.setItem('acad_progress', JSON.stringify(this.progress));
                        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#002654', '#ED2939', '#D4AF37'] });
                    }
                    if (this.currentLessonData.vocabulary) {
                        let existing = this.userVocab.map(v => v.fr);
                        this.currentLessonData.vocabulary.forEach(w => {
                            if (!existing.includes(w.fr)) this.userVocab.push(w);
                        });
                        localStorage.setItem('acad_user_vocab', JSON.stringify(this.userVocab));
                    }
                    document.getElementById('completion-msg').classList.remove('hidden');
                    document.getElementById('completion-msg').scrollIntoView({ behavior: 'smooth' });
                }
            },

            // --- FLASHCARDS ---
            renderFlashcards() {
                if (this.userVocab.length === 0) {
                    this.container.innerHTML = `<div class="h-full flex flex-col items-center justify-center p-6 text-center animate-fade-in">
                        <h2 class="text-2xl font-bold text-frBlue mb-2">Tu mazo está vacío</h2>
                        <button onclick="app.renderMap()" class="bg-frBlue text-white px-6 py-3 rounded-lg font-bold mt-4">Ir al Mapa</button>
                    </div>`;
                    return;
                }
                this.sessionQueue = [...this.userVocab].sort(() => Math.random() - 0.5);
                this.currentCardIdx = 0;
                this.renderCardGameUI();
            },

            renderCardGameUI() {
                if (this.currentCardIdx >= this.sessionQueue.length) {
                    this.container.innerHTML = `<div class="h-full flex flex-col items-center justify-center bg-frBlue text-white"><h2 class="text-3xl font-bold">¡Repaso terminado!</h2><button onclick="app.renderMap()" class="mt-6 bg-white/20 px-6 py-3 rounded-lg">Volver</button></div>`;
                    return;
                }
                const word = this.sessionQueue[this.currentCardIdx];
                this.container.innerHTML = `
                    <div class="h-full flex flex-col bg-gray-100 relative">
                        <div class="p-4 flex justify-between items-center"><button onclick="app.renderMap()"><i class="fa-solid fa-xmark text-xl"></i></button><div class="text-xs font-bold">${this.currentCardIdx + 1}/${this.sessionQueue.length}</div></div>
                        <div class="flex-1 flex items-center justify-center perspective-1000">
                            <div class="w-80 h-80 relative transform-style-3d transition-transform duration-500 cursor-pointer group" onclick="this.classList.toggle('rotate-y-180')">
                                <div class="absolute inset-0 bg-white rounded-xl shadow-xl flex items-center justify-center backface-hidden border-2 border-white"><h2 class="text-3xl font-serif font-bold text-frBlue">${word.fr}</h2></div>
                                <div class="absolute inset-0 bg-frBlue rounded-xl shadow-xl flex items-center justify-center backface-hidden rotate-y-180 border-4 border-white"><h2 class="text-2xl font-serif font-bold text-white">${word.es}</h2></div>
                            </div>
                        </div>
                        <div class="p-6 bg-white flex gap-4 justify-center"><button onclick="app.nextCard(false)" class="text-frRed font-bold">Mal</button><button onclick="app.nextCard(true)" class="text-green-600 font-bold">Bien</button></div>
                    </div>
                `;
            },

            nextCard(known) {
                if (!known) this.sessionQueue.push(this.sessionQueue[this.currentCardIdx]);
                this.currentCardIdx++;
                this.renderCardGameUI();
            }
        };
        app.init();
    </script>
</body>
</html>