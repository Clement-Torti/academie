<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>L'Acad√©mie</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&family=Montserrat:wght@400;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link rel="icon" type="image/x-icon" href="academie.png">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Montserrat', 'sans-serif'], serif: ['Merriweather', 'serif'] },
                    colors: {
                        frBlue: '#002654',
                        frRed: '#ED2939',
                        frCream: '#F5F5DC',
                        gold: '#D4AF37',
                        bronze: '#CD7F32',
                        silver: '#C0C0C0'
                    },
                    boxShadow: { 'card': '0 10px 15px -3px rgba(0, 0, 0, 0.1)', 'btn': '0px 4px 0px 0px rgba(0,0,0,0.3)' }
                }
            }
        }
    </script>

    <style>
        body {
            overscroll-behavior-y: none;
            -webkit-tap-highlight-color: transparent;
        }

        .perspective-1000 {
            perspective: 1000px;
        }

        .transform-style-3d {
            transform-style: preserve-3d;
        }

        .backface-hidden {
            backface-visibility: hidden;
        }

        .rotate-y-180 {
            transform: rotateY(180deg);
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #002654;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-slide-in {
            animation: slideIn 0.3s ease-out forwards;
        }

        /* Styles for Content */
        .lesson-step h2 {
            color: #002654;
            font-weight: 700;
            margin-bottom: 0.5em;
            font-size: 1.25em;
            font-family: 'Merriweather', serif;
        }

        .lesson-step p {
            margin-bottom: 1em;
            line-height: 1.6;
            color: #374151;
            font-size: 1rem;
        }

        .lesson-step ul {
            list-style-type: disc;
            padding-left: 1.2em;
            margin-bottom: 1em;
        }

        .lesson-step strong {
            color: #ED2939;
            font-weight: 700;
        }

        textarea,
        input {
            font-size: 16px !important;
        }

        /* Modal Animation */
        .modal-enter {
            opacity: 0;
            transform: scale(0.95);
        }

        .modal-enter-active {
            opacity: 1;
            transform: scale(1);
            transition: all 0.2s ease-out;
        }

        /* --- CONJUGAISON CHALLENGE STYLES --- */
        .conj-card {
            background: #eff6ff;
            border: 2px solid #dbeafe;
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            /* Prevent it from being too wide on desktop */
            width: 100%;
        }

        .conj-card.is-negative {
            background: #fef2f2;
            border-color: #fecaca;
        }

        .tense-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: #2563eb;
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .tense-badge:hover {
            transform: scale(1.05);
            background: #1d4ed8;
        }

        .neg-badge {
            background: #dc2626;
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
            display: none;
            animation: pulse 1.5s infinite;
        }

        .verb-source {
            font-size: 2rem;
            font-weight: 800;
            text-transform: uppercase;
            color: #1e3a8a;
            margin: 10px 0;
        }

        .correct-answer {
            font-size: 1.5rem;
            color: #059669;
            font-weight: bold;
            padding: 1rem;
            border: 2px dashed #059669;
            border-radius: 12px;
            background: #ecfdf5;
            margin-top: 1rem;
            animation: slideIn 0.3s ease-out forwards;
        }

        /* Help Modal Styles */
        .cj-modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            backdrop-filter: blur(2px);
        }

        .cj-rule-box {
            background: #f0f9ff;
            padding: 10px;
            border-left: 4px solid #2563eb;
            margin: 10px 0;
            text-align: left;
            font-size: 0.9rem;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
            }
        }

        @keyframes pulse-gold {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.1);
                opacity: 0.8;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .animate-pulse-gold {
            animation: pulse-gold 2s infinite;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800 h-[100dvh] flex flex-col overflow-hidden">

    <!-- NAVBAR -->
    <nav class="bg-frBlue text-white shadow-lg z-50 relative shrink-0">
        <div class="max-w-5xl mx-auto px-4 h-14 flex justify-between items-center">

            <div class="flex items-center gap-4">
                <!-- Logo / Home -->
                <div class="flex items-center gap-2 cursor-pointer active:opacity-70 transition"
                    onclick="app.renderMap()">
                    <i class="fa-solid fa-landmark text-gold text-xl"></i>
                    <h1 class="font-bold text-base tracking-wider uppercase hidden sm:block">L'Acad√©mie</h1>
                </div>

                <!-- STREAK COUNTER -->
                <div class="flex items-center gap-1.5 bg-white/10 px-3 py-1 rounded-full border border-white/10">
                    <i class="fa-solid fa-fire text-orange-400 text-sm animate-pulse"></i>
                    <span id="streak-display" class="text-xs font-bold text-white font-mono">0 jour</span>
                </div>
            </div>

            <!-- RIGHT BUTTONS -->
            <div class="flex items-center gap-2">
                <!-- New Verbes Button -->
                <button onclick="app.loadFreestyleVerbs()"
                    class="bg-white/10 active:bg-white/20 text-white px-3 py-1.5 rounded-lg text-xs font-bold transition flex items-center gap-2">
                    <i class="fa-solid fa-dumbbell text-gold"></i> <span class="hidden sm:inline">Verbes</span>
                </button>

                <!-- Renamed Vocab Button -->
                <button onclick="app.renderFlashcards()"
                    class="bg-white/10 active:bg-white/20 text-white px-3 py-1.5 rounded-lg text-xs font-bold transition flex items-center gap-2">
                    <i class="fa-solid fa-layer-group text-gold"></i> <span>Vocab</span>
                </button>
            </div>
        </div>

        <div class="h-1 w-full flex">
            <div class="w-1/3 bg-blue-600"></div>
            <div class="w-1/3 bg-white"></div>
            <div class="w-1/3 bg-red-600"></div>
        </div>
    </nav>

    <!-- MODAL OVERLAY -->
    <div id="selection-modal"
        class="fixed inset-0 z-[60] bg-black/50 backdrop-blur-sm hidden flex items-center justify-center p-4"
        onclick="app.closeModal(event)">
        <!-- Content injected by JS -->
    </div>

    <!-- MAIN CONTENT -->
    <main id="app-container" class="flex-1 overflow-y-auto relative bg-[#fdfbf7] w-full">
        <div class="h-full flex flex-col items-center justify-center">
            <div class="loader"></div>
            <p class="text-gray-500 mt-2 text-sm">Chargement...</p>
        </div>
    </main>

    <script>

        const conjApp = {
            dataUrl: "https://clement-torti.github.io/academie/verbs.html",
            db: {},
            roundsPlayed: 0,
            maxRounds: 3,
            score: 0,
            bestScore: parseInt(localStorage.getItem('acad_cj_best') || '0'), // Load best score
            timer: 60,
            interval: null,
            currentCard: null,
            tenses: ['present', 'pc', 'imparfait', 'futur', 'subjonctif', 'conditionnel', 'imperatif'],

            pronounsEs: ["Yo", "T√∫", "√âl/Ella/Usted", "Nosotros", "Vosotros", "Ellos/Ustedes"],
            pronounsFr: ["Je", "Tu", "Il/Elle", "Nous", "Vous", "Ils/Elles"],

            rules: {
                "present": "Action actuelle / v√©rit√© g√©n√©rale.<br><div class='cj-rule-box'><strong>Formation :</strong> Radical + terminaisons selon le groupe.<br><table class='cj-table'><thead><tr><th></th><th>1er groupe<br>(-ER)</th><th>2e groupe<br>(-IR)</th><th>3e groupe<br>(mod√®le -RE)</th></tr></thead><tbody><tr><td>je</td><td>-e</td><td>-is</td><td>-s</td></tr><tr><td>tu</td><td>-es</td><td>-is</td><td>-s</td></tr><tr><td>il / elle</td><td>-e</td><td>-it</td><td>‚Äî</td></tr><tr><td>nous</td><td>-ons</td><td>-issons</td><td>-ons</td></tr><tr><td>vous</td><td>-ez</td><td>-issez</td><td>-ez</td></tr><tr><td>ils / elles</td><td>-ent</td><td>-issent</td><td>-ent</td></tr></tbody></table><strong>N√©gation :</strong> Je <em>ne</em> parle <em>pas</em>.</div>",
                "pc": "Pass√© termin√© / actions ponctuelles.<br><div class='cj-rule-box'><strong>Formation :</strong> Auxiliaire pr√©sent + participe pass√©.<br><table class='cj-table'><thead><tr><th></th><th>Avoir (pr√©sent)</th><th>√ätre (pr√©sent)</th><th>Participe pass√©<br>1er / 2e / 3e groupe</th></tr></thead><tbody><tr><td>je</td><td>ai</td><td>suis</td><td>-√© / -i / -u</td></tr><tr><td>tu</td><td>as</td><td>es</td><td>-√© / -i / -u</td></tr><tr><td>il</td><td>a</td><td>est</td><td>-√© / -i / -u</td></tr><tr><td>nous</td><td>avons</td><td>sommes</td><td>-√© / -i / -u</td></tr><tr><td>vous</td><td>avez</td><td>√™tes</td><td>-√© / -i / -u</td></tr><tr><td>ils</td><td>ont</td><td>sont</td><td>-√© / -i / -u</td></tr></tbody></table><strong>N√©gation :</strong> Je <em>n'</em>ai <em>pas</em> mang√©.</div>",
                "imparfait": "Description / habitude / action longue au pass√©.<br><div class='cj-rule-box'><strong>Formation :</strong> Radical = nous (pr√©sent) ‚Äì ons + terminaisons.<br><table class='cj-table'><thead><tr><th></th><th>Terminaison (tous groupes)</th></tr></thead><tbody><tr><td>je</td><td>-ais</td></tr><tr><td>tu</td><td>-ais</td></tr><tr><td>il / elle</td><td>-ait</td></tr><tr><td>nous</td><td>-ions</td></tr><tr><td>vous</td><td>-iez</td></tr><tr><td>ils / elles</td><td>-aient</td></tr></tbody></table><strong>N√©gation :</strong> Je <em>ne</em> mangeais <em>pas</em>.</div>",
                "futur": "Projet ou certitude dans l'avenir.<br><div class='cj-rule-box'><strong>Formation :</strong> Infinitif (ou radical irr√©gulier) + terminaisons.<br><table class='cj-table'><thead><tr><th></th><th>Terminaison (tous groupes)</th></tr></thead><tbody><tr><td>je</td><td>-ai</td></tr><tr><td>tu</td><td>-as</td></tr><tr><td>il / elle</td><td>-a</td></tr><tr><td>nous</td><td>-ons</td></tr><tr><td>vous</td><td>-ez</td></tr><tr><td>ils / elles</td><td>-ont</td></tr></tbody></table><strong>N√©gation :</strong> Je <em>ne</em> partirai <em>pas</em>.</div>",
                "imperatif": "Ordre ou conseil.<br><div class='cj-rule-box'><strong>Formation :</strong> 3 formes : tu / nous / vous. Terminaisons proches du pr√©sent.<br><table class='cj-table'><thead><tr><th></th><th>1er groupe</th><th>2e groupe</th><th>3e groupe</th></tr></thead><tbody><tr><td>tu</td><td>-e</td><td>-is</td><td>-s</td></tr><tr><td>nous</td><td>-ons</td><td>-issons</td><td>-ons</td></tr><tr><td>vous</td><td>-ez</td><td>-issez</td><td>-ez</td></tr></tbody></table><strong>N√©gation :</strong> <em>Ne</em> parle <em>pas</em> !</div>",
                "conditionnel": "Politesse / hypoth√®se / souhait.<br><div class='cj-rule-box'><strong>Formation :</strong> Infinitif (ou radical irr√©gulier) + terminaisons de l‚Äôimparfait.<br><table class='cj-table'><thead><tr><th></th><th>Terminaisons (tous groupes)</th></tr></thead><tbody><tr><td>je</td><td>-ais</td></tr><tr><td>tu</td><td>-ais</td></tr><tr><td>il / elle</td><td>-ait</td></tr><tr><td>nous</td><td>-ions</td></tr><tr><td>vous</td><td>-iez</td></tr><tr><td>ils / elles</td><td>-aient</td></tr></tbody></table><strong>N√©gation :</strong> Je <em>ne</em> voudrais <em>pas</em>.</div>",
                "subjonctif": "Souhait / obligation / doute / √©motion.<br><div class='cj-rule-box'><strong>Formation :</strong> Radical = ils (pr√©sent) ‚Äì ent + terminaisons du subjonctif.<br><table class='cj-table'><thead><tr><th></th><th>Terminaisons (tous groupes)</th></tr></thead><tbody><tr><td>je</td><td>-e</td></tr><tr><td>tu</td><td>-es</td></tr><tr><td>il / elle</td><td>-e</td></tr><tr><td>nous</td><td>-ions</td></tr><tr><td>vous</td><td>-iez</td></tr><tr><td>ils / elles</td><td>-ent</td></tr></tbody></table><strong>N√©gation :</strong> Il faut que tu <em>ne</em> viennes <em>pas</em>.</div>"
            },

            async init() {

                window.speechSynthesis.getVoices();

                if (Object.keys(this.db).length === 0) {
                    try {
                        const res = await fetch(this.dataUrl);
                        const text = await res.text();
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(text, 'text/html');
                        this.db = JSON.parse(doc.getElementById('verbs-data').textContent);
                    } catch (e) {
                        console.error("Verbs load failed", e);
                        this.db = { "parler": { "fr": "parler", "present": ["parle", "parles", "parle", "parlons", "parlez", "parlent"], "pc": ["ai parl√©", "as parl√©", "a parl√©", "avons parl√©", "avez parl√©", "ont parl√©"] } };
                    }
                }
                this.roundsPlayed = 0;
                // Refresh best score in case it changed
                this.bestScore = parseInt(localStorage.getItem('acad_cj_best') || '0');
                this.renderIntro();
            },

            renderIntro() {
                const remaining = this.maxRounds - this.roundsPlayed;
                app.container.innerHTML = `
            <div class="h-full flex flex-col items-center justify-center p-6 bg-frCream text-center">
                <div class="mb-4 animate-bounce">
                    <i class="fa-solid fa-dumbbell text-5xl text-frBlue"></i>
                </div>
                <h2 class="text-2xl font-serif font-bold text-frBlue mb-1">D√©fi Conjugaison</h2>
                <p class="text-gray-500 mb-6 text-sm">Compl√©tez ${this.maxRounds} s√©ries de 60s.</p>
                
                <!-- Best Score Display -->
                <div class="mb-6 flex items-center justify-center gap-2 text-gold font-bold bg-white px-4 py-2 rounded-full shadow-sm border border-orange-100">
                    <i class="fa-solid fa-trophy"></i> Record : ${this.bestScore}
                </div>

                <div class="bg-white p-5 rounded-xl border border-gray-200 mb-8 w-full max-w-xs shadow-sm">
                    <div class="text-[10px] uppercase tracking-widest text-gray-400 mb-3 font-bold">Progression de la session</div>
                    <div class="flex justify-center gap-2 mb-2">
                        ${Array(this.maxRounds).fill(0).map((_, i) =>
                    `<div class="h-2 flex-1 rounded-full transition-colors duration-500 ${i < this.roundsPlayed ? 'bg-green-500' : 'bg-gray-200'}"></div>`
                ).join('')}
                    </div>
                    <div class="text-xs font-bold text-gray-500">${this.roundsPlayed} / ${this.maxRounds} termin√©es</div>
                </div>

                <button onclick="conjApp.startRound()" class="w-full max-w-xs bg-frBlue text-white font-bold py-4 rounded-xl shadow-btn active:translate-y-1 transition hover:bg-blue-900">
                    ${this.roundsPlayed === 0 ? 'Commencer' : 'S√©rie Suivante'}
                </button>
            </div>
        `;
            },

            startRound() {
                this.score = 0;
                this.timer = 60;
                this.renderGame();
                this.nextCard();

                if (this.interval) clearInterval(this.interval);
                this.interval = setInterval(() => {
                    this.timer--;
                    const el = document.getElementById('cj-timer');
                    if (el) el.innerText = this.timer + 's';

                    if (this.timer <= 0) {
                        clearInterval(this.interval);
                        this.endRound();
                    }
                }, 1000);
            },

            renderGame() {
                // Updated Layout: Centered max-width container
                app.container.innerHTML = `
            <div class="h-full bg-gray-50 flex flex-col items-center pt-4 px-4 pb- safe-pb overflow-y-auto">
                <div class="w-full max-w-md mx-auto flex flex-col h-full">
                    
                    <!-- Header -->
                    <div class="flex justify-between items-center mb-6 shrink-0">
                        <div class="font-bold text-xl text-frBlue bg-white px-4 py-1 rounded-lg shadow-sm border border-gray-100"><span id="cj-score">0</span> pts</div>
                        <div class="font-bold text-xl text-red-500 bg-white px-4 py-1 rounded-lg shadow-sm border border-gray-100 w-20 text-center" id="cj-timer">60s</div>
                    </div>

                    <!-- Game Area -->
                    <div class="flex-1 flex flex-col justify-start gap-4">
                        
                        <!-- Question Card (Persists) -->
                        <div id="cj-question-area"></div>

                        <!-- Answer Container (Fills up) -->
                        <div id="cj-answer-container" class="empty:hidden"></div>
                    </div>

                    <!-- Bottom Buttons -->
                    <div id="cj-btn-area" class="mt-4 mb-4 shrink-0">
                        <!-- Buttons injected via JS -->
                    </div>
                </div>
            </div>
            
            <!-- Modal Container (Hidden by default) -->
            <div id="cj-help-modal" class="hidden"></div>
        `;
            },

            nextCard() {
                const qArea = document.getElementById('cj-question-area');
                const aArea = document.getElementById('cj-answer-container');
                const bArea = document.getElementById('cj-btn-area');
                if (!qArea) return;

                aArea.innerHTML = '';

                const level = app.getHighestCompletedLesson();

                // Map: tense ‚Üí minimum lesson required
                const unlock = {
                    present: 0,
                    pc: 22,
                    imparfait: 31,
                    futur: 25,
                    imperatif: 37,
                    subjonctif: 61,
                    conditionnel: 67
                };

                // Filter tenses based on level
                const availableTenses = this.tenses.filter(t => level >= unlock[t]);
                // Fallback safety: if somehow empty, default to present
                const tense = availableTenses.length > 0
                    ? availableTenses[Math.floor(Math.random() * availableTenses.length)]
                    : 'present';

                const keys = Object.keys(this.db);
                const key = keys[Math.floor(Math.random() * keys.length)];

                const isNeg = Math.random() < 0.25;

                let pIdx = Math.floor(Math.random() * 6);

                if (tense === 'imperatif') {
                    const valid = [1, 3, 4];
                    if (this.db[key].imperatif && this.db[key].imperatif[1] === "-") {
                        this.nextCard();
                        return;
                    }
                    pIdx = valid[Math.floor(Math.random() * valid.length)];
                }

                this.currentCard = { key, tense, pIdx, isNeg };

                const formatTense = t => ({
                    present: 'Pr√©sent',
                    pc: 'Pass√© Comp.',
                    imparfait: 'Imparfait',
                    futur: 'Futur',
                    imperatif: 'Imp√©ratif',
                    subjonctif: 'Subjonctif',
                    conditionnel: 'Conditionnel'
                }[t] || t);

                qArea.innerHTML = `
            <div class="conj-card ${isNeg ? 'is-negative' : ''} shadow-sm">
                <div class="flex justify-center gap-2 mb-4 flex-wrap">
                    <div class="tense-badge" onclick="conjApp.showHelp('${tense}')" title="Voir la r√®gle">
                        <i class="fa-regular fa-lightbulb mr-1"></i> ${formatTense(tense)}
                    </div>
                    <div class="neg-badge" style="display:${isNeg ? 'inline-flex' : 'none'}">N√âGATION</div>
                </div>
                <div class="verb-source">${key}</div>
                <div class="text-gray-600">Pronom : <strong class="text-frBlue text-xl ml-1">${this.pronounsEs[pIdx]}</strong></div>
            </div>
        `;

                bArea.innerHTML = `
            <button onclick="conjApp.reveal()" class="w-full bg-frBlue text-white font-bold py-4 rounded-xl shadow-btn active:translate-y-1 transition uppercase tracking-widest text-sm hover:bg-blue-900">
                V√©rifier
            </button>
        `;
            },


            reveal() {
                const { key, tense, pIdx, isNeg } = this.currentCard;
                const data = this.db[key];

                // --- 1. CONJUGAISON CONSTRUCTION LOGIC ---
                const startsVowel = w => ['a', 'e', 'i', 'o', 'u', 'y', '√©', '√™', 'h'].includes(w.charAt(0).toLowerCase());

                // Get raw conjugation based on tense
                let raw = (tense === 'pc') ? data.pc[pIdx] : (tense === 'imperatif' ? data.imperatif[pIdx] : data[tense][pIdx]);

                let conj = "";

                // Apply logic for Compound Tenses / Imperative / Negation
                if (tense === 'pc') {
                    const [aux, ...rest] = raw.split(' ');
                    const pp = rest.join(' ');
                    if (isNeg) {
                        const ne = startsVowel(aux) ? "n'" : "ne ";
                        conj = `${ne}${aux} pas ${pp}`;
                    } else conj = raw;
                } else if (tense === 'imperatif') {
                    if (isNeg) {
                        const ne = startsVowel(raw) ? "N'" : "Ne ";
                        conj = `${ne}${raw.toLowerCase()} pas !`;
                    } else conj = raw + " !";
                } else {
                    if (isNeg) {
                        const ne = startsVowel(raw) ? "n'" : "ne ";
                        conj = `${ne}${raw} pas`;
                    } else conj = raw;
                }

                // Add Pronoun (if not Imperative)
                let full = conj;
                if (tense !== 'imperatif') {
                    let pron = this.pronounsFr[pIdx].split('/')[0];
                    if (!isNeg && pIdx === 0 && startsVowel(conj)) full = `J'${conj}`;
                    else full = `${pron} ${conj}`;
                }

                // --- 2. UPDATE DOM ---
                const aArea = document.getElementById('cj-answer-container');
                const bArea = document.getElementById('cj-btn-area');

                // Prepare text for the onclick attribute (escape apostrophes)
                const safeText = full.replace(/'/g, "\\'");

                // Insert HTML (Includes a click-to-replay feature)
                aArea.innerHTML = `
                    <div class="text-center animate-slide-in">
                        <div class="text-xs text-gray-400 font-bold uppercase tracking-widest mb-1">R√©ponse</div>
                        <div class="correct-answer shadow-sm border-l-4 border-green-500 cursor-pointer hover:bg-green-100 transition" onclick="app.speakFrench('${safeText}')">
                            ${full} <i class="fa-solid fa-volume-high text-sm opacity-50 ml-2"></i>
                        </div>
                        <div class="text-gray-400 text-lg italic mt-2"><strong> ${data.fr.toUpperCase()} </strong></div>
                    </div>
                `;

                // Update Button to "Next"
                bArea.innerHTML = `
                    <button onclick="conjApp.handleNext()" class="w-full bg-green-500 text-white font-bold py-4 rounded-xl shadow-btn active:translate-y-1 transition uppercase tracking-widest text-sm hover:bg-green-600">
                        Suivant (+1) <i class="fa-solid fa-arrow-right ml-2"></i>
                    </button>
                `;

                // Auto-scroll on mobile
                bArea.scrollIntoView({ behavior: 'smooth', block: 'end' });

                // --- 3. TRIGGER AUTOMATIC SPEECH ---
                // We use a tiny timeout to ensure the UI thread has updated first
                setTimeout(() => {
                    app.speakFrench(full);
                }, 50);
            },

            handleNext() {
                this.score++;
                document.getElementById('cj-score').innerText = this.score;
                this.nextCard();
            },

            showHelp(tense) {
                const modal = document.getElementById('cj-help-modal');
                const content = this.rules[tense] || "Pas de r√®gle disponible.";
                const title = tense.toUpperCase();

                modal.innerHTML = `
            <div class="cj-modal-backdrop" onclick="document.getElementById('cj-help-modal').classList.add('hidden')">
                <div class="bg-white p-6 rounded-2xl max-w-md w-full shadow-2xl animate-enter" onclick="event.stopPropagation()">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-frBlue text-lg">${title}</h3>
                        <button onclick="document.getElementById('cj-help-modal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times text-xl"></i></button>
                    </div>
                    <div class="text-gray-700 leading-relaxed">${content}</div>
                </div>
            </div>
        `;
                modal.classList.remove('hidden');
            },

            endRound() {
                this.roundsPlayed++;

                // CHECK HIGH SCORE
                if (this.score > this.bestScore) {
                    this.bestScore = this.score;
                    localStorage.setItem('acad_cj_best', this.bestScore);
                    // Optional: Celebration effect here
                    if (window.confetti) confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                }

                if (this.roundsPlayed >= this.maxRounds) {
                    app.completeLesson();
                } else {
                    this.renderIntro();
                }
            }
        };

        const app = {
            container: document.getElementById('app-container'),
            modal: document.getElementById('selection-modal'),
            modules: [],
            progress: {},
            userVocab: JSON.parse(localStorage.getItem('acad_user_vocab') || '[]'),
            baseUrl: 'https://clement-torti.github.io/academie/',
            progress: {},
            highScores: JSON.parse(localStorage.getItem('acad_highscores') || '{}'),
            streak: 0,
            startTime: null,

            dialogueState: {
                paragraphs: [], // Holds the text and DOM elements
                currentIndex: 0,
                isPlaying: false,
                rate: 0.9,
                utterance: null
            },

            // State
            lessonSteps: [],
            currentStepIdx: 0,
            currentLessonMeta: null,

            // Review State
            reviewDeck: [],
            reviewIndex: 0,

            // Add these properties to the top of the 'app' object
            batchSize: 20,
            nextLessonId: 1,
            hasMoreLessons: true,
            isFetching: false,

            async init() {
                // Migration logic (Keep existing)
                const rawProgress = JSON.parse(localStorage.getItem('acad_progress') || '{}');
                if (Array.isArray(rawProgress)) {
                    const newProgress = {};
                    rawProgress.forEach(id => newProgress[id] = 1);
                    this.progress = newProgress;
                    localStorage.setItem('acad_progress', JSON.stringify(this.progress));
                } else {
                    this.progress = rawProgress;
                }

                this.calculateStreak();

                // --- NEW: Initialize Map Structure first, then load first batch ---
                this.initMap();

                // --- NEW: Infinite Scroll Listener ---
                this.container.addEventListener('scroll', () => {
                    const { scrollTop, scrollHeight, clientHeight } = this.container;
                    // Load more when user is 200px from bottom
                    if (scrollTop + clientHeight >= scrollHeight - 200) {
                        this.loadNextBatch();
                    }
                });

                let resizeTimer;
                window.addEventListener('resize', () => {
                    clearTimeout(resizeTimer);
                    resizeTimer = setTimeout(() => this.drawMapPath(), 100);
                });
            },

            initMap() {
                this.modal.classList.add('hidden');

                // Intro Card HTML (Same as before)
                const introCard = `
            <div class="w-full px-6 pt-8 pb-4 relative z-20">
                <div class="bg-white p-6 rounded-2xl shadow-card border border-blue-100 text-center relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-frBlue via-white to-frRed"></div>
                
                    <h2 class="text-xl font-serif font-bold text-frBlue mb-3 mt-1">Bienvenue √† Paris! üá´üá∑</h2>

                    <p class="text-xs text-gray-500 mb-2 leading-relaxed">
                    Olv√≠date de la superficialidad de la app del b√∫ho ü¶â. Aqu√≠, en el universo de <em>Emily in Paris</em>, buscamos elegancia y profundidad. Si te gusta este proyecto, puedes invitarme un croissant abajo a trav√©s de una peque√±a donaci√≥n.
                    </p>
                <a href="https://buymeacoffee.com/ctorti" target="_blank"
                class="inline-block mt-2 px-4 py-2 bg-frBlue text-white text-xs font-semibold rounded-xl shadow hover:bg-blue-700 transition">
                Invitar un croissant ü•ê
                </a>
                    <div class="flex justify-center">
                        <button id="btn-copy-prog" onclick="app.copyProgram()" class="text-[10px] text-gray-400 font-bold uppercase tracking-wider hover:text-gold transition flex items-center gap-1 py-2">
                            <i class="fa-regular fa-clipboard"></i> Copier le programme
                        </button>
                    </div>

                </div>
            </div>`;

                // Set up the persistent container structure
                this.container.innerHTML = `
            <div class="min-h-full relative overflow-x-hidden bg-[#fdfbf7]">
                <svg id="map-svg" class="absolute inset-0 w-full h-full pointer-events-none"><path id="map-path" d="" fill="none" stroke="#cbd5e1" stroke-width="4" stroke-dasharray="8 8" stroke-linecap="round"/></svg>
                <div class="max-w-md mx-auto flex flex-col items-center w-full overflow-hidden">
                    ${introCard}
                    <!-- Nodes will be appended here -->
                    <div id="nodes-container" class="w-full pt-6 pb-24"></div>
                    <!-- Loading Indicator for Scroll -->
                    <div id="scroll-loader" class="py-4 hidden"><div class="loader w-6 h-6 border-2"></div></div>
                </div>
            </div>`;

                // Load the first batch
                this.loadNextBatch();
            },

            async loadNextBatch() {
                if (this.isFetching || !this.hasMoreLessons) return;

                this.isFetching = true;
                const loader = document.getElementById('scroll-loader');
                if (loader) loader.classList.remove('hidden');

                const newModules = [];
                let count = 0;

                // Try to fetch 'batchSize' number of lessons
                while (count < this.batchSize && this.hasMoreLessons) {
                    const url = `${this.baseUrl}lesson${this.nextLessonId}.html`;
                    try {
                        const res = await fetch(url);
                        if (res.ok) {
                            const text = await res.text();
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(text, 'text/html');
                            const jsonScript = doc.getElementById('lesson-data');

                            if (jsonScript) {
                                const data = JSON.parse(jsonScript.textContent);

                                // 1. Theory Node
                                newModules.push({
                                    id: this.nextLessonId,
                                    uid: `${this.nextLessonId}_theory`,
                                    type: 'theory',
                                    url: url,
                                    title: `Le√ßon ${this.nextLessonId}`,
                                    topic: data.title,
                                    desc: data.desc,
                                    icon: data.icon
                                });

                                // 2. Practice Node
                                newModules.push({
                                    id: this.nextLessonId,
                                    uid: `${this.nextLessonId}_practice`,
                                    type: 'practice',
                                    url: url,
                                    title: `Exercice ${this.nextLessonId}`,
                                    topic: "Practica",
                                    desc: "",
                                    icon: 'fa-dumbbell'
                                });
                            }
                            this.nextLessonId++;
                            count++; // We count "lessons" found, though we push 2 modules per lesson
                        } else {
                            this.hasMoreLessons = false;
                        }
                    } catch (e) {
                        this.hasMoreLessons = false;
                    }
                }

                if (loader) loader.classList.add('hidden');

                if (newModules.length > 0) {
                    // Append to main list
                    const startIndex = this.modules.length;
                    this.modules = [...this.modules, ...newModules];
                    // Render only the new ones
                    this.appendNodes(newModules, startIndex);
                }

                this.isFetching = false;
            },

            appendNodes(newMods, startIndex) {
                const nodesContainer = document.getElementById('nodes-container');
                if (!nodesContainer) return;

                let nodesHtml = '';

                newMods.forEach((mod, localIndex) => {
                    const globalIndex = startIndex + localIndex;
                    const masteryLevel = this.progress[mod.uid] || 0;

                    // --- 1. HIGH SCORE LOGIC (Score/Max) ---
                    const rawScoreData = this.highScores ? this.highScores[mod.uid] : undefined;
                    let displayScore = '';

                    // Handle new object format {score: x, max: y} vs old number format
                    if (rawScoreData !== undefined) {
                        if (typeof rawScoreData === 'object' && rawScoreData !== null) {
                            displayScore = `${rawScoreData.score}/${rawScoreData.max}`;
                        } else {
                            displayScore = `${rawScoreData}`; // Backwards compatibility
                        }
                    }

                    // --- 2. LOCK LOGIC ---
                    // Currently unlocked. Change to 'true' based on index if you want sequential locking.
                    const isLocked = false;

                    // --- 3. STYLING LOGIC ---
                    const offset = globalIndex % 2 === 0 ? '-translate-x-8 sm:-translate-x-12' : 'translate-x-8 sm:translate-x-12';
                    let colorClass, borderClass, opacityClass, clickAction, iconHtml;

                    if (isLocked) {
                        colorClass = 'bg-gray-200 text-gray-400';
                        borderClass = 'border-gray-300';
                        opacityClass = 'opacity-70 grayscale';
                        clickAction = '';
                        iconHtml = '<i class="fa-solid fa-lock text-sm"></i>';
                    } else {
                        clickAction = mod.type === 'theory' ? `app.loadLesson(${globalIndex})` : `app.loadPractice(${globalIndex})`;
                        opacityClass = '';

                        // Color schemes based on mastery level
                        if (masteryLevel === 0) {
                            if (mod.type === 'theory') {
                                colorClass = 'bg-frBlue text-white';
                                borderClass = 'border-blue-900';
                            } else {
                                colorClass = 'bg-white text-frBlue border-2 border-frBlue';
                                borderClass = 'border-blue-200';
                            }
                            opacityClass = 'scale-110';
                        } else if (masteryLevel === 1) {
                            colorClass = 'bg-bronze text-white';
                            borderClass = 'border-[#8B4513]';
                        } else if (masteryLevel === 2) {
                            colorClass = 'bg-silver text-white';
                            borderClass = 'border-gray-400';
                        } else {
                            colorClass = 'bg-gold text-white';
                            borderClass = 'border-yellow-600';
                        }

                        // Icon selection
                        if (masteryLevel > 0) iconHtml = `<i class="fa-solid ${masteryLevel >= 3 ? 'fa-crown' : 'fa-check'}"></i>`;
                        else iconHtml = `<i class="fa-solid ${mod.icon}"></i>`;
                    }

                    // --- 4. BADGE HTML GENERATION ---
                    // Only show badge for Practice nodes that have a score
                    let scoreBadgeHtml = '';
                    if (mod.type === 'practice' && displayScore !== '') {
                        scoreBadgeHtml = `
                        <div class="absolute -top-2 -right-3 bg-white border border-gray-200 shadow-sm text-[10px] font-bold px-2 py-0.5 rounded-full text-frBlue z-20 flex items-center gap-1 animate-slide-in">
                            <i class="fa-solid fa-star text-gold text-[8px]"></i> ${displayScore}
                        </div>`;
                    }

                    // --- 5. BUILD NODE HTML ---
                    nodesHtml += `
            <div class="flex flex-col items-center mb-16 relative z-10 pointer-events-none w-full animate-slide-in">
                <div class="pointer-events-auto flex flex-col items-center transition-all duration-300 ${offset} ${opacityClass}" id="node-${globalIndex}">
                    <button onclick="${clickAction}" 
                        class="relative w-16 h-16 sm:w-20 sm:h-20 rounded-full text-2xl flex items-center justify-center border-b-4 shadow-xl active:scale-95 transition-all active:translate-y-1 ${colorClass} ${borderClass}">
                        
                        <!-- SCORE BADGE -->
                        ${scoreBadgeHtml}

                        <!-- MAIN ICON -->
                        ${iconHtml}
                        
                        <!-- MASTERY DOTS (If level 1 or 2) -->
                        ${!isLocked && masteryLevel > 0 && masteryLevel < 3 ? `<div class="absolute -bottom-2 flex gap-0.5">${Array(masteryLevel).fill('<div class="w-1.5 h-1.5 rounded-full bg-frBlue border border-white"></div>').join('')}</div>` : ''}
                    </button>
                    
                    <div class="mt-2 text-center w-full">
                        <div class="inline-block mb-2 bg-white/90 backdrop-blur px-3 py-1 rounded-full shadow-sm text-[10px] font-bold text-gray-600 border border-gray-100 uppercase tracking-widest max-w-[16rem] sm:max-w-[18rem] whitespace-normal break-words leading-tight">
                            ${mod.topic}
                        </div>
                    </div>
                </div>
            </div>`;
                });

                nodesContainer.insertAdjacentHTML('beforeend', nodesHtml);

                // Redraw SVG path to connect new nodes
                setTimeout(() => this.drawMapPath(), 100);
            },

            // --- 1. DISCOVERY ---
            async discoverModules() {
                this.modules = []; // Reset
                let id = 1;
                let searching = true;
                while (searching) {
                    const url = `${this.baseUrl}lesson${id}.html`;
                    try {
                        const res = await fetch(url);
                        if (res.ok) {
                            const text = await res.text();
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(text, 'text/html');
                            const jsonScript = doc.getElementById('lesson-data');

                            if (jsonScript) {
                                const data = JSON.parse(jsonScript.textContent);

                                // PUSH 1: THEORY NODE
                                this.modules.push({
                                    id: id,
                                    uid: `${id}_theory`, // Unique ID for progress
                                    type: 'theory',
                                    url: url,
                                    title: `Le√ßon ${id}`,
                                    topic: data.title,
                                    desc: data.desc,
                                    icon: data.icon
                                });

                                // PUSH 2: PRACTICE NODE
                                this.modules.push({
                                    id: id,
                                    uid: `${id}_practice`, // Unique ID for progress
                                    type: 'practice',
                                    url: url, // We pass lesson URL, loadPractice handles the rest
                                    title: `Exercice ${id}`,
                                    topic: "Practica",
                                    desc: "",
                                    icon: 'fa-dumbbell'
                                });
                            }
                            id++;
                        } else { searching = false; }
                    } catch (e) { searching = false; }
                }

                if (this.modules.length === 0) this.container.innerHTML = `<div class="p-10 text-center">No lessons found.</div>`;
                else this.renderMap();
            },

            // --- 2. MAP RENDERING ---
            // Redirect existing calls to the new initMap
            renderMap() {
                // Reset everything to handle "Back to Menu" correctly
                this.modules = [];
                this.nextLessonId = 1;
                this.hasMoreLessons = true;
                this.initMap();
            },

            // --- MODAL LOGIC ---
            openLessonModal(index) {
                const mod = this.modules[index];
                this.modal.innerHTML = `
                    <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl border-2 border-frCream relative animate-enter" onclick="event.stopPropagation()">
                        <button onclick="app.closeModal()" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times text-xl"></i></button>
                        
                        <div class="text-center mb-6">
                            <span class="text-xs font-bold text-gold uppercase tracking-widest">Le√ßon ${mod.id}</span>
                            <h2 class="text-2xl font-serif font-bold text-frBlue mt-1">${mod.title}</h2>
                        </div>

                        <div class="grid gap-3">
                            <button onclick="app.loadLesson(${index})" class="flex items-center justify-between w-full p-4 bg-frBlue text-white rounded-xl shadow-btn active:shadow-none active:translate-y-1 transition">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center text-lg"><i class="fa-solid fa-book-open"></i></div>
                                    <div class="text-left">
                                        <div class="font-bold text-sm">Th√©orie</div>
                                        <div class="text-[10px] opacity-80">Lecci√≥n completa</div>
                                    </div>
                                </div>
                                <i class="fa-solid fa-chevron-right text-xs"></i>
                            </button>

                            <button onclick="app.loadPractice(${index})" class="flex items-center justify-between w-full p-4 bg-white border-2 border-frBlue text-frBlue rounded-xl shadow-sm active:bg-gray-50 transition">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-frBlue/10 rounded-full flex items-center justify-center text-lg"><i class="fa-solid fa-dumbbell"></i></div>
                                    <div class="text-left">
                                        <div class="font-bold text-sm">Pratique</div>
                                        <div class="text-[10px] opacity-80">Ejercicios intensivos</div>
                                    </div>
                                </div>
                                <i class="fa-solid fa-chevron-right text-xs"></i>
                            </button>
                        </div>
                    </div>
                `;
                this.modal.classList.remove('hidden');
            },

            closeModal(e) {
                if (!e || e.target === this.modal || e.target.closest('button')) {
                    this.modal.classList.add('hidden');
                }
            },

            drawMapPath() {
                const path = document.getElementById('map-path');
                if (!path || this.modules.length < 2) return;
                const contRect = this.container.getBoundingClientRect();
                let d = '';
                for (let i = 0; i < this.modules.length - 1; i++) {
                    const currEl = document.getElementById(`node-${i}`);
                    const nextEl = document.getElementById(`node-${i + 1}`);
                    if (!currEl || !nextEl) continue;
                    const curr = currEl.getBoundingClientRect();
                    const next = nextEl.getBoundingClientRect();
                    const x1 = curr.left + curr.width / 2;
                    const y1 = curr.top + curr.height / 2 - contRect.top + this.container.scrollTop;
                    const x2 = next.left + next.width / 2;
                    const y2 = next.top + next.height / 2 - contRect.top + this.container.scrollTop;
                    if (i === 0) d += `M ${x1} ${y1} `;
                    d += `C ${x1} ${y1 + (y2 - y1) / 2}, ${x2} ${y1 + (y2 - y1) / 2}, ${x2} ${y2} `;
                }
                path.setAttribute('d', d);
            },

            // --- 3A. LESSON ENGINE (Standard) ---
            async loadLesson(index) {
                this.startTime = Date.now();
                const mod = this.modules[index];
                this.currentModIndex = index;
                this.container.innerHTML = `<div class="h-full flex items-center justify-center"><div class="loader"></div></div>`;

                this.lessonSteps = [];

                // ---------------------------------
                // 1. LOAD PREVIOUS LESSON (Rappel)
                // ---------------------------------
                if (index > 0) {
                    try {
                        const previousLessonRes = await fetch(this.modules[index - 1].url);
                        if (!previousLessonRes.ok) throw new Error("Previous lesson missing");

                        const previousLessonHtml = await previousLessonRes.text();
                        const parser = new DOMParser();
                        const prevDoc = parser.parseFromString(previousLessonHtml, "text/html");

                        const prevSections = prevDoc.querySelectorAll("section");

                        if (prevSections.length >= 2) {
                            this.lessonSteps.push({
                                type: 'read',
                                html: `
                        <div class="mb-4 pb-2 border-b border-gray-100">
                            <span class="bg-frBlue text-white px-2 py-1 rounded text-[10px] font-bold uppercase">Rappel</span>
                        </div>
                        ${prevSections[1].innerHTML}
                    `
                            });
                        }
                    } catch (e) {
                        console.warn("Previous lesson could not be loaded:", e.message);
                    }
                }

                // ---------------------------------
                // 2. LOAD CURRENT LESSON (Normal)
                // ---------------------------------
                try {
                    const res = await fetch(mod.url);
                    const html = await res.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');

                    this.setupDialoguePlayer(doc); 

                    // Extract sections
                    const contentDiv = doc.getElementById('lesson-content');
                    let sections = Array.from(contentDiv.querySelectorAll('section'));
                    if (sections.length === 0) sections = [contentDiv];

                    const readSteps = sections.map(s => ({
                        type: 'read',
                        html: s.innerHTML
                    }));

                    // Add them after the rappel step
                    this.lessonSteps.push(...readSteps);

                    // Load metadata
                    const data = JSON.parse(doc.getElementById('lesson-data').textContent);

                    // Insert vocab section as the 4th step (index 3)
                    if (data.vocabulary && data.vocabulary.length > 0) {

                        let vocabListHtml = `<div class="grid grid-cols-1 gap-2">`;
                        data.vocabulary.forEach(word => {
                            vocabListHtml += `
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg border border-gray-100">
                        <span class="font-bold text-sm  text-frBlue">${word.fr}</span>
                        <span class="text-gray-500 text-sm italic">${word.es}</span>
                    </div>`;
                        });
                        vocabListHtml += `</div>`;

                        const vocabSection = {
                            type: "read",
                            html: `
                    <div class="text-center mb-6">
                        <i class="fa-solid fa-book-bookmark text-4xl text-gold mb-2"></i>
                        <h2 class="text-xl font-bold text-frBlue">Vocabulaire</h2>
                    </div>
                    ${vocabListHtml}
                `
                        };

                        // Insert at index 3 (4th position)
                        const insertIndex = (this.currentModIndex === 0) ? 2 : 3;
                        this.lessonSteps.splice(insertIndex, 0, vocabSection);
                    }

                    this.currentLessonMeta = {
                        ...data,
                        id: mod.id,
                        uid: mod.uid,
                        type: 'theory',
                        moduleIndex: index
                    };

                    this.currentStepIdx = 0;
                    this.renderStep();

                } catch (e) {
                    console.error(e);
                    this.container.innerHTML = `
            <div class="p-10 text-center text-red-500">
                Error loading lesson.
            </div>`;
                }
            },

            // --- 3B. PRACTICE ENGINE (New) ---
            async loadPractice(index) {
                this.startTime = Date.now();
                const mod = this.modules[index];
                this.container.innerHTML = `<div class="h-full flex items-center justify-center"><div class="loader"></div></div>`;
                this.currentScore = 0;

                try {
                    // 1. Load Lesson X (for Vocab + Section 2)
                    const lessonRes = await fetch(mod.url);
                    if (!lessonRes.ok) throw new Error("Lesson not found");
                    const lessonHtml = await lessonRes.text();
                    const parser = new DOMParser();
                    const lessonDoc = parser.parseFromString(lessonHtml, 'text/html');
                    const lessonData = JSON.parse(lessonDoc.getElementById('lesson-data').textContent);

                    // 2. Load Exercices X
                    const exUrl = `${this.baseUrl}exercices${mod.id}.html`;
                    const exRes = await fetch(exUrl);
                    if (!exRes.ok) throw new Error("Exercices file not found");
                    const exHtml = await exRes.text();
                    const exDoc = parser.parseFromString(exHtml, 'text/html');

                    // Parse JSON Data
                    const exScript = exDoc.getElementById('exercise-data');
                    if (!exScript) throw new Error("No JSON data found in exercise file");
                    const exData = JSON.parse(exScript.textContent);

                    this.currentScore = 0;
                    this.currentMaxScore = exData.interactive_exercises
                        ? exData.interactive_exercises.filter(ex => ex.type !== 'full_translation').length
                        : 0;
                    // BUILD STEPS
                    this.lessonSteps = [];

                    // Step 1: Vocabulary (Visual)
                    if (lessonData.vocabulary && lessonData.vocabulary.length > 0) {
                        let vocabListHtml = `<div class="grid grid-cols-1 gap-2">`;
                        lessonData.vocabulary.forEach(word => {
                            vocabListHtml += `
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg border border-gray-100">
                            <span class="font-bold text-frBlue">${word.fr}</span>
                            <span class="text-gray-500 text-sm italic">${word.es}</span>
                        </div>`;
                        });
                        vocabListHtml += `</div>`;

                        this.lessonSteps.push({
                            type: 'read',
                            html: `
                        <div class="text-center mb-6"><i class="fa-solid fa-book-bookmark text-4xl text-gold mb-2"></i><h2 class="text-xl font-bold text-frBlue">Vocabulaire</h2></div>
                        ${vocabListHtml}
                    `
                        });
                    }

                    // Step 2: Section 2 of Lesson (Refresher)
                    const lessonSections = lessonDoc.querySelectorAll('section');
                    if (lessonSections.length >= 2) {
                        this.lessonSteps.push({
                            type: 'read',
                            html: `
                        <div class="mb-4 pb-2 border-b border-gray-100">
                            <span class="bg-frBlue text-white px-2 py-1 rounded text-[10px] font-bold uppercase">Rappel</span>
                        </div>
                        ${lessonSections[1].innerHTML}
                    `
                        });
                    }

                    // Step 3: Interactive JSON Exercises
                    if (exData.interactive_exercises) {
                        exData.interactive_exercises.forEach(ex => {
                            this.lessonSteps.push({
                                type: 'interactive_practice',
                                data: ex
                            });
                        });
                    }

                    this.currentLessonMeta = { ...lessonData, id: mod.id, uid: mod.uid, mode: 'practice', type: 'practice', moduleIndex: index };
                    this.currentStepIdx = 0;
                    this.renderStep();

                } catch (e) {
                    console.error(e);
                    this.container.innerHTML = `<div class="p-10 text-center flex flex-col items-center">
                <i class="fa-solid fa-triangle-exclamation text-4xl text-frRed mb-4"></i>
                <p class="text-gray-600">Erreur de chargement.</p>
                <p class="text-xs text-gray-400 mt-2">${e.message}</p>
                <button onclick="app.renderMap()" class="mt-6 font-bold text-frBlue underline">Retour</button>
            </div>`;
                }
            },

            prevStep() {
                if (this.currentStepIdx > 0) {
                    this.currentStepIdx--;
                    this.renderStep();
                }
            },


            renderStep() {
                if (this.currentStepIdx >= this.lessonSteps.length) {
                    this.prepareEndReview();
                    return;
                }

                const step = this.lessonSteps[this.currentStepIdx];
                const progress = ((this.currentStepIdx + 0.5) / this.lessonSteps.length) * 100;

                const navBtn = `<button onclick="app.prevStep()" class="text-gray-400 p-2 hover:text-frBlue transition">
                    <i class="fa-solid fa-arrow-left text-xl"></i>
                </button>`;

                // 1. CONDITIONAL LOGIC FOR SCORE BADGE
                // Only generate this HTML if the current mode is 'practice'
                const isPractice = this.currentLessonMeta && this.currentLessonMeta.type === 'practice';

                const scoreBadgeHtml = isPractice ? `
                    <div class="bg-white border border-gray-200 px-3 py-1 rounded-full flex items-center gap-2 shadow-sm animate-slide-in">
                        <i class="fa-solid fa-star text-gold text-xs"></i>
                        <span id="score-display" class="font-bold text-frBlue text-xs transition-all duration-300">
                            ${this.currentScore} / ${this.currentMaxScore}
                        </span>
                    </div>` : '';

                let html = `
            <div class="h-full flex flex-col bg-frCream relative">
                <div class="px-4 py-3 flex items-center gap-3 max-w-2xl mx-auto w-full bg-frCream z-30 shrink-0 border-b border-gray-100/50">
                    ${navBtn}
                    
                    <!-- 2. INSERT CONDITIONAL BADGE HERE -->
                    ${scoreBadgeHtml}

                    <div class="flex-1 h-3 bg-gray-200 rounded-full overflow-hidden shadow-inner">
                        <div class="h-full bg-green-500 transition-all duration-500 ease-out" style="width: ${progress}%"></div>
                    </div>
                </div>
                
                <div class="flex-1 overflow-y-auto px-4 w-full animate-slide-in">
                    <div class="max-w-2xl mx-auto w-full flex flex-col justify-start pb-36 pt-4">
        `;

                if (step.type === 'read') {
                    html += `<div class="lesson-section bg-white p-5 sm:p-8 rounded-xl shadow-sm border border-gray-100 text-lg leading-relaxed">${step.html}</div>`;
                }
                else if (step.type === 'interactive_practice') {
                    html += `<div class="lesson-section bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                        ${this.renderInteractiveExercise(step.data)}
                     </div>`;
                }
                else if (step.type === 'quiz') {
                    html += `
                <div class="bg-white p-5 rounded-xl shadow-card border border-gray-100 mb-4">
                    <div class="text-lg text-gray-800 mb-4 font-serif">${step.q}</div>
                    <textarea id="inp-quiz" class="w-full p-3 text-lg border-2 border-gray-200 rounded-lg focus:border-frBlue focus:outline-none transition bg-gray-50 resize-none" rows="2"></textarea>
                </div>
                <div id="feedback" class="hidden rounded-lg p-4 font-bold text-center text-sm"></div>`;
                }

                html += `
                    </div>
                </div>
                <div class="fixed bottom-0 left-0 w-full bg-white/95 backdrop-blur border-t border-gray-200 p-4 z-40 safe-pb">
                    <div class="max-w-2xl mx-auto">
                        ${step.type === 'read'
                        ? `<button onclick="app.nextStep()" class="w-full bg-frBlue text-white font-bold py-4 rounded-xl shadow-btn active:shadow-none active:translate-y-1 transition uppercase tracking-wider text-sm">Continuer</button>`
                        : `<button id="btn-check" onclick="app.checkInteractive()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 rounded-xl shadow-btn active:shadow-none active:translate-y-1 transition uppercase tracking-wider text-sm">V√©rifier</button>
                           <button id="btn-next" onclick="app.nextStep()" class="hidden w-full bg-frBlue text-white font-bold py-4 rounded-xl shadow-btn active:shadow-none active:translate-y-1 transition uppercase tracking-wider text-sm">Continuer</button>`
                    }
                    </div>
                </div>
            </div>
        `;
                this.container.innerHTML = html;
            },

            // --- GENERATE HTML FOR NEW EXERCISE TYPES ---
            renderInteractiveExercise(ex) {
                let contentHtml = '';
                const instruction = `<div class="flex items-center gap-2 mb-4"><span class="bg-gold text-white px-2 py-0.5 rounded text-xs font-bold uppercase">Exercice</span><span class="text-xs text-gray-500 font-bold uppercase tracking-widest">${ex.instruction}</span></div>`;
                const prompt = ex.prompt ? `<div class="text-xl font-serif text-frBlue font-bold mb-6 text-center">${ex.prompt.replace('______', '<span class="border-b-2 border-frBlue w-12 inline-block mx-1"></span>')}</div>` : '';

                switch (ex.type) {
                    // --- NEW TYPE START ---
                    case 'expression':
                        // Hide the default "Check" button immediately using inline style
                        contentHtml += `<style>#btn-check { display: none !important; }</style>`;

                        // Theme Box
                        contentHtml += `
                        <div class="bg-white p-6 rounded-xl border-2 border-frBlue/10 shadow-lg mb-8 text-center relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-400 to-frBlue"></div>
                            <h3 class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-3">Votre Sujet</h3>
                            <div class="font-serif text-xl text-frBlue leading-relaxed">
                                ${ex.content.theme}
                            </div>
                        </div>`;

                        // Timer UI
                        const mins = Math.floor(ex.content.duration_seconds / 60).toString().padStart(2, '0');
                        const secs = (ex.content.duration_seconds % 60).toString().padStart(2, '0');

                        contentHtml += `
                        <div class="flex flex-col items-center justify-center py-4">
                            <div id="timer-ring" class="relative w-48 h-48 flex items-center justify-center rounded-full border-4 border-gray-100 mb-8 transition-colors duration-500">
                                <div id="timer-display" class="text-5xl font-mono font-bold text-gray-700">${mins}:${secs}</div>
                                <div class="absolute -bottom-8 text-xs text-gray-400 font-bold uppercase tracking-widest">Chrono</div>
                            </div>

                            <button id="btn-start-timer" onclick="app.startExpressionTimer(${ex.content.duration_seconds})" 
                                class="bg-frBlue text-white text-lg font-bold py-4 px-12 rounded-full shadow-lg hover:bg-blue-900 hover:scale-105 active:scale-95 transition flex items-center gap-3">
                                <i class="fa-solid fa-microphone"></i> Commencer √† parler
                            </button>
                            
                            <p id="timer-hint" class="mt-4 text-sm text-gray-400 italic">Le bouton "Continuer" appara√Ætra √† la fin du temps.</p>
                        </div>`;
                        break;
                    // --- NEW TYPE END ---

                    // ... existing cases (reading_comprehension, selection_single, etc.) ...
                    case 'reading_comprehension':
                        // ... existing code ...
                        contentHtml += `
                        <div class="bg-frCream/50 p-6 rounded-xl border border-gray-200 mb-8 shadow-inner">
                            <i class="fa-solid fa-quote-left text-gold text-2xl mb-2 opacity-50"></i>
                            <div class="font-serif text-lg leading-loose text-gray-700">
                                ${ex.content.text}
                            </div>
                        </div>`;
                        contentHtml += `<div class="space-y-6">`;
                        ex.content.questions.forEach((q, idx) => {
                            contentHtml += `
                            <div class="bg-white p-4 rounded-lg border-l-4 border-frBlue shadow-sm">
                                <div class="font-bold text-gray-800 mb-2 flex gap-2">
                                    <span class="text-frBlue">Q${idx + 1}.</span> ${q.prompt}
                                </div>
                                <div class="reading-answer hidden mt-3 pt-3 border-t border-gray-100 text-green-700 font-medium animate-slide-in">
                                    <i class="fa-solid fa-check mr-2"></i> ${q.answer}
                                </div>
                            </div>`;
                        });
                        contentHtml += `</div>`;
                        contentHtml += `
                        <div class="mt-8 text-center">
                            <button id="btn-reveal-reading" onclick="app.revealReadingAnswers()" class="bg-white border-2 border-gold text-gold hover:bg-gold hover:text-white px-6 py-3 rounded-full font-bold transition shadow-sm flex items-center gap-2 mx-auto">
                                <i class="fa-regular fa-lightbulb"></i> Voir les r√©ponses
                            </button>
                        </div>`;
                        break;

                    case 'selection_single':
                        contentHtml = `<div class="grid gap-3 question-block">`;
                        ex.content.options.forEach(opt => {
                            contentHtml += `<button onclick="app.selectOption(this, '${opt.id}')" class="option-btn w-full text-left p-4 rounded-xl border-2 border-gray-100 hover:border-frBlue/50 bg-white font-semibold text-lg transition relative group">
                        ${opt.text}
                        <div class="absolute right-4 top-1/2 -translate-y-1/2 w-5 h-5 rounded-full border-2 border-gray-300 group-hover:border-frBlue selection-indicator"></div>
                    </button>`;
                        });
                        contentHtml += `</div>`;
                        break;

                    case 'sentence_builder':
                        const allWords = [...ex.content.segments || []].sort(() => Math.random() - 0.5);
                        contentHtml = `
                    <div id="build-area" class="min-h-[60px] bg-white border-b-2 border-frBlue mb-6 p-2 flex flex-wrap gap-2 items-center justify-center transition-colors rounded-t-lg"></div>
                    <div id="word-bank" class="flex flex-wrap justify-center gap-2">
                        ${allWords.map((w, i) => `<button onclick="app.moveWord(this)" class="word-chip bg-white border border-gray-200 shadow-sm px-3 py-2 rounded-lg font-bold text-frBlue active:scale-95 transition">${w}</button>`).join('')}
                    </div>`;
                        break;

                    case 'full_translation':
                        const specialChars = ex.content.special_characters || [];
                        const charButtons = specialChars.map(char =>
                            `<button onclick="document.getElementById('inp-blank').value += '${char}'; document.getElementById('inp-blank').focus();" class="w-8 h-8 bg-gray-100 hover:bg-gray-200 rounded shadow-sm font-serif text-lg text-frBlue transition">${char}</button>`
                        ).join('');

                        contentHtml = `
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 text-center">
                        <textarea id="inp-blank" rows="2" class="w-full text-center text-xl p-2 border-b-2 border-gray-300 focus:border-frBlue focus:outline-none bg-transparent placeholder-gray-300 resize-none" placeholder="${ex.content.placeholder}"></textarea>
                        
                        <div class="flex justify-center gap-2 mt-4 mb-6">${charButtons}</div>

                        <button id="btn-reveal-local" onclick="app.revealAnswer()" class="mx-auto bg-white border-2 border-gold text-gold hover:bg-gold hover:text-white px-6 py-2 rounded-full font-bold transition flex items-center gap-2">
                            <i class="fa-regular fa-eye"></i> Voir la r√©ponse
                        </button>

                        <div id="answer-display" class="hidden mt-6 pt-6 border-t border-gray-100 animate-fade-in">
                            <div class="text-xs uppercase text-gray-400 font-bold tracking-widest mb-2">R√©ponse sugg√©r√©e</div>
                            <div class="text-2xl font-serif text-frBlue font-bold">${ex.content.accepted_answers[0]}</div>
                            <div class="mt-2 text-sm text-gray-500 italic">${ex.feedback?.correct || ''}</div>
                        </div>
                    </div>`;
                        break;

                    case 'true_false':
                        contentHtml = `
                    <div class="grid grid-cols-2 gap-4 h-32">
                        <button onclick="app.selectBool(this, true)" class="bool-btn h-full rounded-xl border-2 border-gray-100 bg-white text-green-600 font-bold text-xl flex flex-col items-center justify-center gap-2 hover:bg-green-50 transition"><i class="fa-solid fa-check"></i> Vrai</button>
                        <button onclick="app.selectBool(this, false)" class="bool-btn h-full rounded-xl border-2 border-gray-100 bg-white text-red-600 font-bold text-xl flex flex-col items-center justify-center gap-2 hover:bg-red-50 transition"><i class="fa-solid fa-xmark"></i> Faux</button>
                    </div>`;
                        break;
                }

                return `
            ${instruction}
            ${prompt}
            <div class="w-full mb-4" id="ex-container">${contentHtml}</div>
            <div id="feedback" class="hidden rounded-lg p-4 font-bold text-center text-sm sm:text-base mb-20"></div>
            `;
            },
            // --- REVEAL ANSWER LOGIC (New) ---
            revealAnswer() {
                const ansDisplay = document.getElementById('answer-display');
                const btnReveal = document.getElementById('btn-reveal-local');
                const btnCheck = document.getElementById('btn-check');
                const btnNext = document.getElementById('btn-next');
                const input = document.getElementById('inp-blank');

                // Show answer UI
                if (ansDisplay) ansDisplay.classList.remove('hidden');
                if (btnReveal) btnReveal.classList.add('hidden');
                if (input) {
                    input.disabled = true;
                    input.classList.add('opacity-50');
                }

                // Manage global navigation
                if (btnCheck) btnCheck.classList.add('hidden');
                if (btnNext) btnNext.classList.remove('hidden');
            },

            revealReadingAnswers() {
                // 1. Show all answers
                document.querySelectorAll('.reading-answer').forEach(el => el.classList.remove('hidden'));

                // 2. Hide the local reveal button
                const btnReveal = document.getElementById('btn-reveal-reading');
                if (btnReveal) btnReveal.classList.add('hidden');

                // 3. Swap Global Buttons (Check -> Next)
                const btnCheck = document.getElementById('btn-check');
                const btnNext = document.getElementById('btn-next');
                if (btnCheck) btnCheck.classList.add('hidden');
                if (btnNext) btnNext.classList.remove('hidden');

                // 4. Update Score (Since it's self-assessed/reading, we give points for completing it)
                if (this.currentLessonMeta.type === 'practice') {
                    const scoreDisplay = document.getElementById('score-display');
                    this.currentScore++;
                    // No negative score possible here
                    if (scoreDisplay) {
                        scoreDisplay.innerText = `${this.currentScore} / ${this.currentMaxScore}`;
                        scoreDisplay.classList.add('text-green-600', 'scale-125');
                        setTimeout(() => scoreDisplay.classList.remove('text-green-600', 'scale-125'), 300);
                    }
                }
            },

            // --- INTERACTION HELPERS ---
            selectOption(btn, id) {
                // Remove old selection completely
                document.querySelectorAll('.option-btn').forEach(b => {
                    b.classList.remove('border-frBlue', 'bg-blue-50', 'selected');
                    b.classList.add('border-gray-100', 'bg-white');
                    b.querySelector('div').classList.remove('bg-frBlue', 'border-frBlue');
                });

                // Apply new selection
                btn.classList.remove('border-gray-100', 'bg-white');
                btn.classList.add('border-frBlue', 'bg-blue-50', 'selected');
                btn.querySelector('div').classList.add('bg-frBlue', 'border-frBlue');

                btn.dataset.selectedId = id;
            },


            moveWord(btn) {
                const bank = document.getElementById('word-bank');
                const area = document.getElementById('build-area');
                if (btn.parentElement === bank) {
                    area.appendChild(btn);
                    btn.classList.add('bg-frBlue', 'text-white');
                    btn.classList.remove('bg-white', 'text-frBlue');
                } else {
                    bank.appendChild(btn);
                    btn.classList.remove('bg-frBlue', 'text-white');
                    btn.classList.add('bg-white', 'text-frBlue');
                }
            },

            selectBool(btn, val) {
                document.querySelectorAll('.bool-btn').forEach(b => b.classList.remove('ring-4', 'ring-frBlue/30', 'border-frBlue', 'selected'));
                btn.classList.add('ring-4', 'ring-frBlue/30', 'border-frBlue', 'selected');
                btn.dataset.val = val;
            },

            // --- VALIDATION LOGIC ---
            checkInteractive() {
                const step = this.lessonSteps[this.currentStepIdx];
                const ex = step.data;
                const feed = document.getElementById('feedback');
                const btnCheck = document.getElementById('btn-check');
                const btnNext = document.getElementById('btn-next');
                let isCorrect = false;
                let feedbackMsg = '';

                if (ex.type === 'reading_comprehension') {
                    this.revealReadingAnswers();
                    return;
                }

                // SPECIAL CASE: Fill in blank (Translation) - No validation, just reveal
                if (ex.type === 'full_translation') {
                    this.revealAnswer();
                    return;
                }

                // 1. VALIDATE BASED ON TYPE
                switch (ex.type) {

                    case 'expression':
                        // Hide the default "Check" button immediately using inline style
                        contentHtml += `<style>#btn-check { display: none !important; }</style>`;

                        // Theme Box
                        contentHtml += `
                        <div class="bg-white p-6 rounded-xl border-2 border-frBlue/10 shadow-lg mb-8 text-center relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-400 to-frBlue"></div>
                            <h3 class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-3">Votre Sujet</h3>
                            <div class="font-serif text-xl text-frBlue leading-relaxed">
                                ${ex.content.theme}
                            </div>
                        </div>`;

                        // Timer UI
                        const mins = Math.floor(ex.content.duration_seconds / 60).toString().padStart(2, '0');
                        const secs = (ex.content.duration_seconds % 60).toString().padStart(2, '0');

                        contentHtml += `
                        <div class="flex flex-col items-center justify-center py-4">
                            <div id="timer-ring" class="relative w-48 h-48 flex items-center justify-center rounded-full border-4 border-gray-100 mb-8 transition-colors duration-500">
                                <div id="timer-display" class="text-5xl font-mono font-bold text-gray-700">${mins}:${secs}</div>
                                <div class="absolute -bottom-8 text-xs text-gray-400 font-bold uppercase tracking-widest">Chrono</div>
                            </div>

                            <button id="btn-start-timer" onclick="app.startExpressionTimer(${ex.content.duration_seconds})" 
                                class="bg-frBlue text-white text-lg font-bold py-4 px-12 rounded-full shadow-lg hover:bg-blue-900 hover:scale-105 active:scale-95 transition flex items-center gap-3">
                                <i class="fa-solid fa-microphone"></i> Commencer √† parler
                            </button>
                            
                            <p id="timer-hint" class="mt-4 text-sm text-gray-400 italic">Le bouton "Continuer" appara√Ætra √† la fin du temps.</p>
                        </div>`;
                        break;
                    case 'selection_single':
                        const selBtn = document.querySelector('.option-btn.selected');
                        if (!selBtn) return;
                        isCorrect = selBtn.dataset.selectedId === ex.content.correct_option_id;
                        feedbackMsg = isCorrect ? (ex.feedback?.correct || "Correct !") : (ex.feedback?.incorrect || "Incorrect.");
                        break;

                    case 'sentence_builder':
                        const userOrder = Array.from(document.getElementById('build-area').children).map(b => b.innerText.trim());
                        const correctOrder = ex.content.correct_order;
                        isCorrect = JSON.stringify(userOrder) === JSON.stringify(correctOrder);
                        feedbackMsg = isCorrect ? (ex.feedback?.correct || "Phrase correcte !") : `Ordre correct : "${correctOrder.join(' ')}"`;
                        break;

                    case 'true_false':
                        const boolBtn = document.querySelector('.bool-btn.selected');
                        if (!boolBtn) return;
                        const userBool = boolBtn.dataset.val === 'true';
                        isCorrect = userBool === ex.content.is_correct;
                        feedbackMsg = isCorrect ? "Exact !" : (ex.content.explanation || "Ce n'est pas correct.");
                        break;
                }

                if (this.currentLessonMeta.type === 'practice') {
                    const scoreDisplay = document.getElementById('score-display');

                    if (isCorrect) {
                        this.currentScore++;
                        // Visual flair for correct
                        if (scoreDisplay) {
                            scoreDisplay.classList.add('text-green-600', 'scale-125');
                            setTimeout(() => scoreDisplay.classList.remove('text-green-600', 'scale-125'), 300);
                        }
                    } else {
                        this.currentScore--;
                        // Visual flair for wrong
                        if (scoreDisplay) {
                            scoreDisplay.classList.add('text-red-500', 'scale-125');
                            setTimeout(() => scoreDisplay.classList.remove('text-red-500', 'scale-125'), 300);
                        }
                    }

                    // Update text
                    if (scoreDisplay) {
                        scoreDisplay.innerText = `${this.currentScore} / ${this.currentMaxScore}`;
                    }
                }

                // 2. SHOW FEEDBACK
                if (isCorrect) {
                    feed.innerHTML = `<div class="flex items-center justify-center gap-2 text-green-700"><i class="fa-solid fa-circle-check text-xl"></i> <span>${feedbackMsg}</span></div>`;
                    feed.className = "mb-4 rounded-xl p-4 font-bold text-center bg-green-100 animate-bounce";
                    const audio = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3');
                    audio.volume = 0.3; audio.play().catch(e => { });

                    btnCheck.classList.add('hidden');
                    btnNext.classList.remove('hidden');

                    const con = document.getElementById('ex-container');
                    con.style.pointerEvents = 'none';
                    con.style.opacity = '0.8';

                } else {
                    feed.innerHTML = `<div class="flex flex-col gap-1 text-red-700"><div class="flex items-center justify-center gap-2"><i class="fa-solid fa-circle-xmark"></i> <span>Oups !</span></div><div class="text-xs font-normal">${feedbackMsg}</div></div>`;
                    feed.className = "mb-4 rounded-xl p-4 font-bold text-center bg-red-100";
                    feed.classList.remove('hidden');
                }
            },

            nextStep() { this.currentStepIdx++; this.renderStep(); },

            prepareEndReview() {
                const isPractice = this.currentLessonMeta.type === 'practice';
                // 1. Save to Global Vocab (Only if Theory/Lesson)
                if (!isPractice && this.currentLessonMeta.vocabulary) {
                    const existing = this.userVocab.map(v => v.fr);
                    this.currentLessonMeta.vocabulary.forEach(w => {
                        if (!existing.includes(w.fr)) this.userVocab.push(w);
                    });
                    localStorage.setItem('acad_user_vocab', JSON.stringify(this.userVocab));
                }

                // 2. Determine Deck based on Type
                let deckToReview = [];

                if (isPractice) {
                    // Practice Mode: Pick RANDOM 10 words
                    if (this.userVocab.length > 0) {
                        deckToReview = [...this.userVocab]
                            .sort(() => Math.random() - 0.5)
                            .slice(0, 10); // Reduced to 10 for better UX
                    }
                } else {
                    // Theory Mode: Review ONLY this lesson's new words
                    if (this.currentLessonMeta.vocabulary) {
                        deckToReview = this.currentLessonMeta.vocabulary;
                    }
                }

                // 3. Start Review OR Go to Challenge
                if (deckToReview.length > 0) {
                    this.reviewDeck = deckToReview;
                    this.reviewIndex = 0;
                    this.renderLessonVocabReview();
                } else {
                    // TRIGGER CHALLENGE INSTEAD OF COMPLETE
                    this.startConjugationChallenge();
                }
            },

            startConjugationChallenge() {
                // Bridge function to launch the conjugation sub-app
                conjApp.init();
            },

            // --- 1. NEW ROBUST AUDIO FUNCTION ---
            currentUtterance: null, // Variable to prevent Chrome Garbage Collection bug

            speakFrench(text) {
                if (!text) return;

                // Cancel any currently playing audio
                window.speechSynthesis.cancel();

                // Create the utterance
                const utterance = new SpeechSynthesisUtterance(text);

                // 1. VOICE SELECTION: Chrome on Mac works best if we explicitly pick "Google Fran√ßais" or "Thomas"
                const allVoices = window.speechSynthesis.getVoices();

                // Priority: 1. Google Fran√ßais (Best quality on Chrome), 2. Thomas (Mac Default), 3. Any 'fr-FR', 4. Any 'fr'
                const preferredVoice = allVoices.find(v => v.name === "Google fran√ßais") ||
                    allVoices.find(v => v.name === "Thomas") ||
                    allVoices.find(v => v.lang === "fr-FR") ||
                    allVoices.find(v => v.lang.startsWith("fr"));

                if (preferredVoice) {
                    utterance.voice = preferredVoice;
                    utterance.lang = preferredVoice.lang; // Ensure lang matches voice
                } else {
                    utterance.lang = 'fr-FR'; // Fallback
                }

                // 2. SETTINGS
                utterance.rate = 0.85; // Slightly slower
                utterance.pitch = 1;
                utterance.volume = 1.0; // Force max volume

                // 3. STORE REFERENCE (Critical fix for Chrome)
                // We assign it to 'this.currentUtterance' so the browser doesn't delete it while speaking
                this.currentUtterance = utterance;

                // Cleanup reference when done
                utterance.onend = () => { this.currentUtterance = null; };
                utterance.onerror = (e) => { console.error("Audio error:", e); };

                // 4. SPEAK
                window.speechSynthesis.speak(utterance);
            },

            // --- 2. UPDATED CARD GENERATOR ---
            getCardHTML(word, index, total) {
                // Probability Logic
                const rand = Math.random();
                let frontContent, backContent, onRenderAction;

                // Safe string for HTML attributes (escapes apostrophes)
                const safeWord = word.fr.replace(/'/g, "\\'");

                if (rand < 0.40) {
                    // --- 40%: FRENCH TEXT (Read) ---
                    frontContent = `
            <span class="text-xs uppercase tracking-widest text-gray-400 mb-4">Fran√ßais</span>
            <h2 class="text-3xl font-serif font-bold text-frBlue text-center px-4">${word.fr}</h2>
            <div class="mt-8 text-gray-300 text-xs flex items-center gap-2"><i class="fa-solid fa-rotate"></i> Toucher pour retourner</div>
        `;
                    backContent = `
            <span class="text-xs uppercase tracking-widest text-blue-300 mb-4">Espa√±ol</span>
            <h2 class="text-3xl font-serif font-bold text-center px-4">${word.es}</h2>
        `;
                    onRenderAction = null;

                } else if (rand < 0.70) {
                    // --- 30%: SPANISH TEXT (Translate) ---
                    frontContent = `
            <span class="text-xs uppercase tracking-widest text-gray-400 mb-4">Espa√±ol</span>
            <h2 class="text-3xl font-serif font-bold text-frBlue text-center px-4">${word.es}</h2>
            <div class="mt-8 text-gray-300 text-xs flex items-center gap-2"><i class="fa-solid fa-rotate"></i> Toucher pour retourner</div>
        `;
                    backContent = `
            <span class="text-xs uppercase tracking-widest text-blue-300 mb-4">Fran√ßais</span>
            <h2 class="text-3xl font-serif font-bold text-center px-4">${word.fr}</h2>
        `;
                    onRenderAction = null;

                } else {
                    // --- 30%: AUDIO ONLY (Listen) ---

                    // Define the action to run immediately when card renders
                    onRenderAction = () => {
                        this.speakFrench(word.fr);
                    };

                    frontContent = `
            <div class="flex flex-col items-center justify-center h-full">
                <div class="relative">
                    <i class="fa-solid fa-headphones-simple text-6xl text-frBlue mb-6 animate-pulse-gold"></i>
                </div>
                <span class="text-xs uppercase tracking-widest text-gray-400 mb-2">√âcoutez...</span>
                
                <!-- Replay Button -->
                <button onclick="event.stopPropagation(); app.speakFrench('${safeWord}')" 
                    class="mt-4 bg-frBlue/10 hover:bg-frBlue/20 text-frBlue px-4 py-2 rounded-full text-xs font-bold transition flex items-center gap-2 z-20 relative border border-frBlue/20">
                    <i class="fa-solid fa-volume-high"></i> Rejouer
                </button>
            </div>
            <div class="absolute bottom-8 text-gray-300 text-xs flex items-center gap-2"><i class="fa-solid fa-rotate"></i> Toucher pour voir</div>
        `;

                    backContent = `
            <div class="flex flex-col items-center gap-4">
                <div>
                    <span class="text-[10px] uppercase tracking-widest text-blue-300 block mb-1"></span>
                    <h2 class="text-3xl font-serif font-bold text-center px-4">${word.fr}</h2>
                </div>
                <div class="w-12 h-0.5 bg-white/30 rounded-full"></div>
                <div>
                    <span class="text-[10px] uppercase tracking-widest text-blue-300 block mb-1"></span>
                    <h3 class="text-xl font-medium text-center px-4 text-blue-100">${word.es}</h3>
                </div>
            </div>
        `;
                }

                return { frontContent, backContent, onRenderAction };
            },

            // --- UPDATED REVIEW LOGIC ---
            renderLessonVocabReview() {
                if (this.reviewIndex >= this.reviewDeck.length) {
                    this.completeLesson();
                    return;
                }

                const word = this.reviewDeck[this.reviewIndex];
                const isLast = this.reviewIndex === this.reviewDeck.length - 1;
                const progressText = `Mot ${this.reviewIndex + 1} sur ${this.reviewDeck.length}`;
                const isPractice = this.currentLessonMeta.type === 'practice';
                const titleText = isPractice ? "R√©vision Globale" : "M√©morisation";
                const subText = isPractice ? "Mots al√©atoires de vos acquis" : "Vocabulaire de la le√ßon";

                // GENERATE CONTENT
                const { frontContent, backContent, onRenderAction } = this.getCardHTML(word, this.reviewIndex, this.reviewDeck.length);

                this.container.innerHTML = `
            <div class="h-full flex flex-col bg-frCream">
                <div class="px-6 py-6 text-center">
                    <h2 class="text-frBlue font-bold text-lg uppercase tracking-widest mb-1">${titleText}</h2>
                    <p class="text-gray-500 text-sm">${subText}</p>
                </div>

                <div class="flex-1 flex flex-col items-center justify-center perspective-1000 cursor-pointer group px-4 pb-10"
                        onclick="document.querySelector('.card-inner').classList.toggle('rotate-y-180')">
                        
                    <div class="card-inner w-full max-w-[300px] h-[360px] relative transform-style-3d transition-transform duration-500">
                        <!-- FRONT -->
                        <div class="absolute inset-0 bg-white rounded-2xl shadow-card flex flex-col items-center justify-center backface-hidden border-b-4 border-gray-200">
                            ${frontContent}
                        </div>
                        
                        <!-- BACK -->
                        <div class="absolute inset-0 bg-frBlue rounded-2xl shadow-card flex flex-col items-center justify-center backface-hidden rotate-y-180 text-white border-b-4 border-blue-900">
                            ${backContent}
                        </div>
                    </div>
                    
                    <div class="mt-8 text-sm font-bold text-gray-400">${progressText}</div>
                </div>

                <div class="p-6 bg-white border-t border-gray-200 flex gap-3">
                    <button onclick="app.markCardWrong()" 
                            class="w-1/2 bg-red-500 hover:bg-red-600 text-white font-bold py-4 rounded-xl shadow-btn active:shadow-none active:translate-y-1 transition uppercase tracking-wider text-sm">
                        Incorrecto
                    </button>

                    <button onclick="app.nextLessonReviewCard()" 
                            class="w-1/2 bg-green-500 hover:bg-green-600 text-white font-bold py-4 rounded-xl shadow-btn active:shadow-none active:translate-y-1 transition uppercase tracking-wider text-sm">
                        ${isLast ? 'Terminer' : 'Suivant'}
                    </button>
                </div>
            </div>`;

                // Execute auto-play if it's an audio card
                // IMPORTANT: We call this immediately after setting innerHTML so it happens in the same event loop as the user click
                if (onRenderAction) onRenderAction();
            },

            nextLessonReviewCard() {
                this.reviewIndex++;
                if (this.reviewIndex >= this.reviewDeck.length) {
                    // TRIGGER CHALLENGE INSTEAD OF COMPLETE
                    this.startConjugationChallenge();
                } else {
                    this.renderLessonVocabReview();
                }
            },

            markCardWrong() {
                const currentWord = this.reviewDeck[this.reviewIndex];

                // Reinsertar palabra al final
                this.reviewDeck.push(currentWord);

                // Avanzar a la siguiente
                this.reviewIndex++;

                this.renderLessonVocabReview();
            },


            completeLesson() {
                // 1. Progress Logic
                const uid = this.currentLessonMeta.uid;
                const currentLevel = this.progress[uid] || 0;
                // Only increase level if not already maxed (optional, but keeps numbers clean)
                const newLevel = currentLevel + 1;
                this.progress[uid] = newLevel;
                localStorage.setItem('acad_progress', JSON.stringify(this.progress));
                this.sendProgress();

                // 2. High Score Logic
                const isPractice = this.currentLessonMeta.type === 'practice';
                let isNewRecord = false;
                let savedData = this.highScores[uid];
                let previousBest = -Infinity;

                if (isPractice) {
                    if (typeof savedData === 'number') {
                        previousBest = savedData;
                    } else if (savedData && typeof savedData === 'object') {
                        previousBest = savedData.score;
                    }



                    if (this.currentScore > previousBest) {
                        this.highScores[uid] = {
                            score: this.currentScore,
                            max: this.currentMaxScore
                        };
                        localStorage.setItem('acad_highscores', JSON.stringify(this.highScores));
                        isNewRecord = true;
                    }
                }

                // 3. Visuals for CURRENT Level
                let colorText = "";
                let medalIcon = "";
                let levelName = "";

                if (newLevel === 1) {
                    colorText = "text-bronze";
                    medalIcon = "fa-medal";
                    levelName = "Bronze";
                } else if (newLevel === 2) {
                    colorText = "text-silver";
                    medalIcon = "fa-medal";
                    levelName = "Argent";
                } else {
                    colorText = "text-gold";
                    medalIcon = "fa-crown";
                    levelName = "Or";
                }

                const msg = isPractice ? "Exercice Termin√©" : "Le√ßon Termin√©e";
                if (window.confetti) confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });

                // 4. Next Step / Replay Logic
                const nextIndex = this.currentLessonMeta.moduleIndex + 1;
                let btnAction = `app.renderMap()`;
                let btnText = "Retour au menu";

                if (nextIndex < this.modules.length) {
                    const nextMod = this.modules[nextIndex];
                    const fn = nextMod.type === 'theory' ? 'loadLesson' : 'loadPractice';
                    btnAction = `app.${fn}(${nextIndex})`;
                    btnText = `Suivant: ${nextMod.type === 'theory' ? 'Th√©orie' : 'Pratique'}`;
                }

                // --- NEW: REPLAY INCENTIVE HTML ---
                // Define how to replay the CURRENT module
                const replayCurrentAction = this.currentLessonMeta.type === 'theory'
                    ? `app.loadLesson(${this.currentModIndex})`
                    : `app.loadPractice(${this.currentModIndex})`;

                let nextRankHtml = '';

                if (newLevel === 1) {
                    // Bronze -> Encourage Silver
                    nextRankHtml = `
                    <div class="w-full max-w-sm bg-white border-2 border-gray-100 rounded-xl p-4 shadow-sm mb-6 relative overflow-hidden group cursor-pointer" onclick="${replayCurrentAction}">
                        <div class="absolute top-0 left-0 w-1 h-full bg-silver"></div>
                        <div class="flex justify-between items-center">
                            <div class="text-left">
                                <div class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">Niveau Suivant</div>
                                <div class="font-bold text-gray-700 flex items-center gap-2">
                                    <i class="fa-solid fa-medal text-silver"></i> Argent
                                </div>
                            </div>
                            <div class="bg-gray-50 text-frBlue px-4 py-2 rounded-lg text-xs font-bold uppercase group-hover:bg-frBlue group-hover:text-white transition">
                                <i class="fa-solid fa-rotate-right mr-1"></i> Rejouer
                            </div>
                        </div>
                        <p class="text-xs text-gray-400 mt-2 text-left">Refaites la le√ßon pour am√©liorer votre ma√Ætrise.</p>
                    </div>`;
                } else if (newLevel === 2) {
                    // Silver -> Encourage Gold
                    nextRankHtml = `
                    <div class="w-full max-w-sm bg-gradient-to-br from-[#002654] to-black text-white rounded-xl p-4 shadow-xl mb-6 relative overflow-hidden cursor-pointer border border-blue-900" onclick="${replayCurrentAction}">
                        <div class="absolute top-0 right-0 p-4 opacity-10"><i class="fa-solid fa-crown text-6xl"></i></div>
                        <div class="flex justify-between items-center relative z-10">
                            <div class="text-left">
                                <div class="text-[10px] text-blue-200 font-bold uppercase tracking-widest">Le d√©fi final</div>
                                <div class="font-bold text-gold text-lg flex items-center gap-2">
                                    <i class="fa-solid fa-crown"></i> Niveau Or
                                </div>
                            </div>
                            <div class="bg-white/10 backdrop-blur text-white px-4 py-2 rounded-lg text-xs font-bold uppercase hover:bg-white hover:text-frBlue transition border border-white/20">
                                <i class="fa-solid fa-rotate-right mr-1"></i> Rejouer
                            </div>
                        </div>
                    </div>`;
                }
                // If Level 3+ (Gold), we don't show an incentive card, just the success screen.

                // 5. Build Score HTML
                const scoreHtml = isPractice ? `
                    <div class="bg-white border-2 ${isNewRecord ? 'border-gold bg-yellow-50' : 'border-gray-100'} rounded-xl p-4 mb-4 w-full max-w-xs mx-auto transform transition-all shadow-sm">
                        <div class="text-xs uppercase tracking-widest text-gray-500 mb-1">Score Final</div>
                        <div class="flex items-baseline justify-center gap-1 text-frBlue">
                            <span class="text-3xl font-bold">${this.currentScore}</span>
                            <span class="text-lg text-gray-400 font-bold">/ ${this.currentMaxScore}</span>
                        </div>
                        ${isNewRecord
                        ? `<div class="text-xs font-bold text-orange-500 mt-2 animate-bounce"><i class="fa-solid fa-trophy"></i> Nouveau Record !</div>`
                        : `<div class="text-xs text-gray-400 mt-2">Meilleur: ${previousBest} / ${this.currentMaxScore}</div>`
                    }
                    </div>
                ` : '';

                this.container.innerHTML = `
                    <div class="h-full flex flex-col items-center justify-center bg-frCream p-6 text-center animate-step overflow-y-auto">
                        <div class="w-24 h-24 bg-white rounded-full flex items-center justify-center shadow-lg mb-4 text-4xl ${colorText} border-4 border-gray-100 relative shrink-0">
                            <i class="fa-solid ${medalIcon}"></i>
                            ${newLevel > 1 ? `<span class="absolute top-0 right-0 bg-frRed text-white text-xs font-bold w-6 h-6 rounded-full flex items-center justify-center border-2 border-white">x${newLevel}</span>` : ''}
                        </div>
                        
                        <h2 class="text-sm text-gray-400 font-bold uppercase tracking-widest mb-1">Niveau Atteint</h2>
                        <h1 class="text-2xl font-serif font-bold text-frBlue mb-6">${levelName}</h1>
                        
                        ${scoreHtml}

                        <!-- REPLAY INCENTIVE CARD -->
                        ${nextRankHtml}

                        <div class="w-full max-w-sm space-y-3 pb-8">
                            <button onclick="${btnAction}" class="w-full bg-frBlue text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 transition flex items-center justify-center gap-2">
                                <span>${btnText}</span> <i class="fa-solid fa-arrow-right"></i>
                            </button>
                            <button onclick="app.renderMap()" class="w-full text-gray-400 font-bold py-2 text-xs hover:text-gray-600 transition uppercase tracking-widest">Menu Principal</button>
                        </div>
                    </div>`;
            },

            renderFlashcards() {
                if (this.userVocab.length === 0) {
                    this.container.innerHTML = `<div class="h-full flex items-center justify-center flex-col p-6 text-center"><p class="text-gray-500 mb-4">No tienes vocabulario guardado a√∫n.</p><button class="text-frBlue font-bold border border-frBlue px-4 py-2 rounded-lg" onclick="app.renderMap()">Volver</button></div>`;
                    return;
                }
                this.deck = [...this.userVocab].sort(() => Math.random() - 0.5).slice(0, 50);
                this.cardIdx = 0;
                this.renderVoluntaryCard();
            },

            renderVoluntaryCard() {
                if (this.cardIdx >= this.deck.length) {
                    this.container.innerHTML = `
            <div class="h-full flex items-center justify-center flex-col bg-frBlue text-white">
                <i class="fa-solid fa-flag-checkered text-6xl mb-4 text-gold"></i>
                <h2 class="text-xl font-bold mb-4">¬°Repaso terminado!</h2>
                <button onclick="app.renderMap()" class="bg-white/20 px-6 py-3 rounded-lg hover:bg-white/30 transition font-bold">Volver al mapa</button>
            </div>`;
                    return;
                }

                const word = this.deck[this.cardIdx];
                const progressText = `${this.cardIdx + 1} / ${this.deck.length}`;

                // GENERATE CONTENT (Uses same logic)
                const { frontContent, backContent, onRenderAction } = this.getCardHTML(word, this.cardIdx, this.deck.length);

                this.container.innerHTML = `
        <div class="h-full flex flex-col bg-gray-100">
            
            <!-- TOP BAR -->
            <div class="p-4 flex justify-between items-center">
                <button onclick="app.renderMap()" class="bg-gray-200 rounded-full w-8 h-8 flex items-center justify-center hover:bg-gray-300 transition">
                    <i class="fa-solid fa-xmark text-gray-500"></i>
                </button>
                <div class="bg-white px-3 py-1 rounded-full text-gray-500 font-bold text-xs shadow-sm">${progressText}</div>
            </div>

            <div class="flex-1 flex items-center justify-center perspective-1000 cursor-pointer group px-4"
                 onclick="document.querySelector('.card-inner').classList.toggle('rotate-y-180')">
                 
                <div class="card-inner w-full max-w-[300px] h-[400px] relative transform-style-3d transition-transform duration-500">
                    
                    <!-- FRONT -->
                    <div class="absolute inset-0 bg-white rounded-2xl shadow-xl flex flex-col items-center justify-center backface-hidden border-b-4 border-gray-200">
                        ${frontContent}
                    </div>
                    
                    <!-- BACK -->
                    <div class="absolute inset-0 bg-frBlue rounded-2xl shadow-xl flex flex-col items-center justify-center backface-hidden rotate-y-180 text-white border-b-4 border-blue-900">
                        ${backContent}
                    </div>
                </div>
            </div>

            <div class="p-6 pb-8 flex gap-4 justify-center">
                <button onclick="app.markVoluntaryWrong()" 
                        class="bg-red-500 hover:bg-red-600 text-white font-bold px-6 py-4 rounded-xl w-full shadow-sm active:translate-y-1 transition">
                    Me equivoqu√©
                </button>

                <button onclick="app.nextVoluntaryCard()" 
                        class="bg-white border-2 border-gray-200 hover:border-frBlue text-gray-600 hover:text-frBlue px-6 py-4 rounded-xl font-bold w-full shadow-sm active:translate-y-1 transition">
                    Siguiente
                </button>
            </div>
        </div>`;

                // Execute auto-play immediately
                if (onRenderAction) onRenderAction();
            },

            markVoluntaryWrong() {
                const current = this.deck[this.cardIdx];

                // Reinsertar la tarjeta al final del mazo
                this.deck.push(current);

                // Avanzar a la siguiente
                this.cardIdx++;

                this.renderVoluntaryCard();
            },



            nextVoluntaryCard() { this.cardIdx++; this.renderVoluntaryCard(); },

            copyProgram() {
                // Filter only Theory lessons to create the list
                const text = this.modules
                    .filter(m => m.type === 'theory')
                    .map(m => `- ${m.title} : ${m.desc} - desc:  ${m.desc}`)
                    .join('\n');

                navigator.clipboard.writeText(text).then(() => {
                    // Simple visual feedback
                    const btn = document.getElementById('btn-copy-prog');
                    if (btn) {
                        const originalHtml = btn.innerHTML;
                        btn.innerHTML = '<i class="fa-solid fa-check"></i> Copi√© !';
                        setTimeout(() => btn.innerHTML = originalHtml, 2000);
                    }
                }).catch(err => console.error('Erreur de copie', err));
            },

            calculateStreak() {
                const today = new Date().toLocaleDateString('en-CA'); // Gets YYYY-MM-DD in local time
                const lastVisit = localStorage.getItem('acad_last_visit');
                let currentStreak = parseInt(localStorage.getItem('acad_streak') || '0');

                if (!lastVisit) {
                    // First time ever visiting
                    currentStreak = 1;
                } else if (lastVisit !== today) {
                    // Check if last visit was yesterday
                    const yesterdayDate = new Date();
                    yesterdayDate.setDate(yesterdayDate.getDate() - 1);
                    const yesterday = yesterdayDate.toLocaleDateString('en-CA');

                    if (lastVisit === yesterday) {
                        // Continued streak
                        currentStreak++;
                    } else {
                        // Broke the streak (last visit was days ago)
                        currentStreak = 1;
                    }
                }
                // If lastVisit === today, we do nothing (keep current score)

                // Save new state
                localStorage.setItem('acad_last_visit', today);
                localStorage.setItem('acad_streak', currentStreak);

                // Update State and UI
                this.streak = currentStreak;
                const streakEl = document.getElementById('streak-display');
                if (streakEl) streakEl.innerText = this.streak + " d√≠a(s) de racha";
            },

            sendProgress() {

                // Calculate duration
                const durationMs = Date.now() - (this.startTime || Date.now());
                const minutes = Math.floor(durationMs / 60000);
                const seconds = ((durationMs % 60000) / 1000).toFixed(0);
                const timeString = `${minutes}m ${seconds}s`;

                let summary = `
                ${new Date().toISOString()} - Lesson: ${this.currentLessonMeta ? this.currentLessonMeta.uid : 'unknown'} - vocab: ${this.userVocab.length} - Current streak: ${this.streak} days - Duration: ${timeString}`
                    .trim();

                // 2. Check if it is practice mode and append the score
                if (this.currentLessonMeta && this.currentLessonMeta.type === 'practice') {
                    summary += ` - Score: ${this.currentScore}/${this.currentMaxScore}`;
                }
                const formData = new FormData();
                formData.append("entry.571600580", summary);

                // FIXED URL HERE:
                fetch("https://docs.google.com/forms/d/e/1FAIpQLSfDW3YRnP52660mMAtB6Rtcj2cfdyllBRUEIqQxwr4Rpp_ZPQ/formResponse", {
                    method: "POST",
                    body: formData,
                    mode: "no-cors"
                }).then(() => {
                    console.log("‚úÖ Progress sent successfully");
                }).catch(err => {
                    console.error("‚ùå Failed to send progress:", err);
                });
            },
            startExpressionTimer(duration) {
                const display = document.getElementById('timer-display');
                const ring = document.getElementById('timer-ring');
                const btn = document.getElementById('btn-start-timer');
                const hint = document.getElementById('timer-hint');

                // UI Updates
                btn.classList.add('hidden');
                ring.classList.replace('border-gray-100', 'border-frBlue');
                hint.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> √Ä vous de jouer !';
                hint.classList.add('text-frBlue', 'font-bold');

                let remaining = duration;

                // Clear any existing interval
                if (this.expressionInterval) clearInterval(this.expressionInterval);

                this.expressionInterval = setInterval(() => {
                    remaining--;

                    // Format MM:SS
                    const m = Math.floor(remaining / 60).toString().padStart(2, '0');
                    const s = (remaining % 60).toString().padStart(2, '0');
                    display.innerText = `${m}:${s}`;

                    // Visual warning last 10 seconds
                    if (remaining <= 10) {
                        display.classList.add('text-red-500');
                        ring.classList.replace('border-frBlue', 'border-red-500');
                    }

                    if (remaining <= 0) {
                        this.endExpressionTimer();
                    }
                }, 1000);
            },

            endExpressionTimer() {
                clearInterval(this.expressionInterval);

                // Play Success Sound
                const audio = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3');
                audio.volume = 0.3; audio.play().catch(e => { });

                // UI Updates
                const display = document.getElementById('timer-display');
                const ring = document.getElementById('timer-ring');
                const hint = document.getElementById('timer-hint');
                const feedback = document.getElementById('feedback');

                display.innerHTML = '<i class="fa-solid fa-check"></i>';
                ring.classList.replace('border-red-500', 'border-green-500');
                ring.classList.add('bg-green-50', 'text-green-600');

                hint.innerText = "Termin√© !";

                // Show Feedback Message
                feedback.innerHTML = `<div class="flex items-center justify-center gap-2 text-green-700"><i class="fa-solid fa-trophy text-xl"></i> <span>Exercice termin√© !</span></div>`;
                feedback.className = "mb-4 rounded-xl p-4 font-bold text-center bg-green-100 animate-bounce";
                feedback.classList.remove('hidden');

                // Reveal Global NEXT button
                const btnNext = document.getElementById('btn-next');
                if (btnNext) btnNext.classList.remove('hidden');

                // Add Score (Expression is simply "Completed = +1")
                if (this.currentLessonMeta.type === 'practice') {
                    const scoreDisplay = document.getElementById('score-display');
                    this.currentScore++;
                    if (scoreDisplay) {
                        scoreDisplay.innerText = `${this.currentScore} / ${this.currentMaxScore}`;
                        scoreDisplay.classList.add('text-green-600', 'scale-125');
                        setTimeout(() => scoreDisplay.classList.remove('text-green-600', 'scale-125'), 300);
                    }
                }
            },
            loadFreestyleVerbs() {
                // Create dummy metadata so app.completeLesson() works correctly
                this.currentLessonMeta = {
                    id: 'freestyle',
                    uid: 'freestyle_verbs',
                    type: 'practice',
                    title: 'Entra√Ænement Verbes',
                    vocabulary: [],
                    moduleIndex: 9999 // High number ensures "Next Lesson" button is hidden
                };
                // Reset main app scores (Conjugation App keeps its own score)
                this.currentScore = 0;
                this.currentMaxScore = 0;

                // Launch the Challenge
                conjApp.init();
            },


            getHighestCompletedLesson() {
                // Get all keys from the progress object (e.g., ["1_theory", "1_practice", "2_theory"])
                const keys = Object.keys(this.progress);

                if (keys.length === 0) return 0;

                // Map keys to their integer IDs and find the maximum
                // parseInt("10_theory") returns 10, stopping at the non-digit character
                const maxId = Math.max(...keys.map(k => parseInt(k) || 0));

                return maxId;
            },

            setupDialoguePlayer(doc) {
                // 1. LOCATE THE DIALOGUE CONTAINER
                // Strategy: Find the 3rd section (index 2), then the first div with class 'bg-gray-50'
                const sections = doc.querySelectorAll('section');
                if (sections.length < 3) return; // Safety check
                
                const dialogueSection = sections[2];
                const container = dialogueSection.querySelector('div.bg-gray-50');
                
                if (!container) return;

                // 2. EXTRACT PARAGRAPHS
                const pTags = Array.from(container.querySelectorAll('p'));
                if (pTags.length === 0) return;

                // 3. INITIALIZE STATE
                this.dialogueState = {
                    paragraphs: pTags.map(p => ({ 
                        text: p.innerText, 
                        el: p 
                    })),
                    currentIndex: 0,
                    isPlaying: false,
                    rate: 0.75,
                    utterance: null
                };

                // 4. MODIFY DOM: BLUR TEXT & ADD HIGHLIGHT CLASS
                container.id = "dialogue-container";
                container.classList.add('transition-all', 'duration-500', 'blur-sm', 'select-none'); // Blur initially
                
                // Add styling for the active paragraph highlight
                const style = document.createElement('style');
                style.innerHTML = `.highlight-active { background-color: #fef3c7; border-left: 4px solid #D4AF37; padding-left: 10px; transition: all 0.3s; }`;
                document.head.appendChild(style);

                // 5. BUILD THE PLAYER UI
                const playerUI = document.createElement('div');
                playerUI.className = "mb-6 bg-white rounded-xl shadow-card border-2 border-frBlue/10 p-4 sticky top-4 z-20";
                playerUI.innerHTML = `
                    <div class="flex flex-col gap-3">
                        <!-- Top Row: Title & Reveal -->
                        <div class="flex justify-between items-center border-b border-gray-100 pb-2">
                            <div class="text-xs font-bold text-gray-400 uppercase tracking-widest"><i class="fa-solid fa-headphones mr-1"></i> Audio Dialogue</div>
                            <button id="btn-reveal-text" onclick="app.toggleDialogueReveal()" class="text-xs font-bold text-frBlue hover:text-blue-700 transition opacity-50 cursor-not-allowed">
                                <i class="fa-regular fa-eye"></i> R√©v√©ler le texte
                            </button>
                        </div>

                        <!-- Controls Row -->
                        <div class="flex items-center justify-between gap-2">
                            
                            <!-- Speed Control -->
                            <div class="flex items-center gap-2">
                                <span class="text-[10px] text-gray-400 font-bold">Vitesse</span>
                                <input type="range" min="0.5" max="1" step="0.05" value="0.75" 
                                    oninput="app.setDialogueSpeed(this.value)" 
                                    class="w-16 h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                <span id="speed-display" class="text-[10px] font-mono text-frBlue font-bold">0.75x</span>
                            </div>

                            <!-- Playback Buttons -->
                            <div class="flex items-center gap-3">
                                <button onclick="app.dialogueNav(-1)" class="w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 text-frBlue transition flex items-center justify-center">
                                    <i class="fa-solid fa-backward-step"></i>
                                </button>

                                <button id="btn-play-pause" onclick="app.toggleDialoguePlay()" class="w-12 h-12 rounded-full bg-frBlue text-white shadow-lg active:scale-95 hover:bg-blue-900 transition flex items-center justify-center text-xl">
                                    <i class="fa-solid fa-play ml-1"></i>
                                </button>

                                <button onclick="app.dialogueNav(1)" class="w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 text-frBlue transition flex items-center justify-center">
                                    <i class="fa-solid fa-forward-step"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Progress Bar -->
                        <div class="w-full bg-gray-100 h-1.5 rounded-full overflow-hidden mt-1">
                            <div id="dialogue-progress" class="bg-gold h-full w-0 transition-all duration-300"></div>
                        </div>
                        <div class="text-center text-[10px] text-gray-400 font-bold mt-1">
                            <span id="current-step-disp">1</span> / ${pTags.length}
                        </div>
                    </div>
                `;

                // Insert Player BEFORE the text container
                container.parentNode.insertBefore(playerUI, container);
            },

            // --- DIALOGUE CONTROLLER METHODS ---

            toggleDialogueReveal() {
                const container = document.getElementById('dialogue-container');
                const btn = document.getElementById('btn-reveal-text');
                if (container.classList.contains('blur-sm')) {
                    container.classList.remove('blur-sm', 'select-none');
                    btn.innerHTML = '<i class="fa-regular fa-eye-slash"></i> Cacher';
                } else {
                    container.classList.add('blur-sm', 'select-none');
                    btn.innerHTML = '<i class="fa-regular fa-eye"></i> R√©v√©ler le texte';
                }
            },

            setDialogueSpeed(val) {
                this.dialogueState.rate = parseFloat(val);
                document.getElementById('speed-display').innerText = val + 'x';
            },

            dialogueNav(dir) {
                const { paragraphs, currentIndex } = this.dialogueState;
                let newIndex = currentIndex + dir;
                
                // Bounds check
                if (newIndex < 0) newIndex = 0;
                if (newIndex >= paragraphs.length) newIndex = paragraphs.length - 1;

                this.dialogueState.currentIndex = newIndex;
                this.playDialogueStep(); // Auto play on nav
            },

            toggleDialoguePlay() {
                if (this.dialogueState.isPlaying) {
                    window.speechSynthesis.cancel();
                    this.dialogueState.isPlaying = false;
                    this.updatePlayerUI(false);
                } else {
                    this.playDialogueStep();
                }
            },

            playDialogueStep() {
                // Cancel existing
                window.speechSynthesis.cancel();

                const { paragraphs, currentIndex, rate } = this.dialogueState;
                
                if (currentIndex >= paragraphs.length) {
                    // End of dialogue
                    this.dialogueState.isPlaying = false;
                    this.updatePlayerUI(false);
                    
                    // Enable Reveal Button
                    const btnReveal = document.getElementById('btn-reveal-text');
                    btnReveal.disabled = false;
                    btnReveal.classList.remove('opacity-50', 'cursor-not-allowed');
                    btnReveal.classList.add('animate-bounce');
                    return;
                }

                this.dialogueState.isPlaying = true;
                this.updatePlayerUI(true);

                // Highlight Logic
                paragraphs.forEach((p, idx) => {
                    if (idx === currentIndex) {
                        p.el.classList.add('highlight-active', 'bg-yellow-50', 'scale-[1.02]', 'shadow-sm');
                        p.el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    } else {
                        p.el.classList.remove('highlight-active', 'bg-yellow-50', 'scale-[1.02]', 'shadow-sm');
                    }
                });

                // Prepare Text (Remove names like "Antoine :" for smoother reading if desired, 
                // or read as is. Let's read as is but maybe pause after colon)
                let textToRead = paragraphs[currentIndex].text;

                const utterance = new SpeechSynthesisUtterance(textToRead);
                
                // Voice Selection (Reusing your preferred logic)
                const voices = window.speechSynthesis.getVoices();
                const frVoice = voices.find(v => v.name === "Google fran√ßais") || 
                                voices.find(v => v.name === "Thomas") || 
                                voices.find(v => v.lang.startsWith("fr"));
                if (frVoice) utterance.voice = frVoice;
                
                utterance.rate = rate;
                utterance.lang = 'fr-FR';

                // On End: Move to next
                utterance.onend = () => {
                    // Small pause between paragraphs
                    setTimeout(() => {
                        if (this.dialogueState.isPlaying) {
                            this.dialogueState.currentIndex++;
                            this.playDialogueStep();
                        }
                    }, 500); 
                };

                // Store ref to prevent GC
                this.dialogueState.utterance = utterance;
                window.speechSynthesis.speak(utterance);
            },

            updatePlayerUI(isPlaying) {
                const btn = document.getElementById('btn-play-pause');
                if(!btn) return;
                
                if (isPlaying) {
                    btn.innerHTML = '<i class="fa-solid fa-pause"></i>';
                    btn.classList.add('bg-blue-800');
                    btn.classList.remove('bg-frBlue');
                } else {
                    btn.innerHTML = '<i class="fa-solid fa-play ml-1"></i>';
                    btn.classList.remove('bg-blue-800');
                    btn.classList.add('bg-frBlue');
                }

                // Update Progress
                const { paragraphs, currentIndex } = this.dialogueState;
                const pct = ((currentIndex) / paragraphs.length) * 100;
                const bar = document.getElementById('dialogue-progress');
                if(bar) bar.style.width = `${pct}%`;

                const stepDisp = document.getElementById('current-step-disp');
                if(stepDisp) stepDisp.innerText = Math.min(currentIndex + 1, paragraphs.length);
            },
        };
        app.init();
    </script>
</body>

</html>